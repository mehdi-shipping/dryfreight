<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DryFreight Calculator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Sans+Condensed:wght@700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#0d0d10;color:#e8e4dc;font-family:'IBM Plex Sans',system-ui,sans-serif;min-height:100vh}

.wrap{max-width:900px;margin:0 auto;padding:24px 16px 60px}
header{border-bottom:1px solid #1e1e2a;padding-bottom:16px;margin-bottom:28px;display:flex;align-items:baseline;gap:12px}
.logo{font-family:'IBM Plex Sans Condensed',sans-serif;font-size:22px;font-weight:700;color:#f5c842;letter-spacing:.5px}
.logo span{color:#555;font-size:13px;font-weight:400;margin-left:4px}

/* ── form card ── */
.form-card{background:#111118;border:1px solid #1e1e2a;border-radius:10px;padding:24px;display:flex;flex-direction:column;gap:20px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.field label{display:block;font-size:11px;font-weight:600;color:#666;letter-spacing:.8px;text-transform:uppercase;margin-bottom:6px}

/* port search */
.port-wrap{position:relative}
.port-in{width:100%;background:#0d0d10;border:1px solid #222230;border-radius:6px;padding:10px 12px;color:#e8e4dc;font-size:14px;outline:none;transition:border-color .15s}
.port-in:focus{border-color:#f5c842}
.port-in.chosen{border-color:#2a4a1a;color:#90d060}
.port-meta{font-size:11px;color:#555;margin-top:4px;min-height:16px}
.dd{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#16161f;border:1px solid #222230;border-radius:6px;max-height:220px;overflow-y:auto;z-index:100;display:none}
.dd.open{display:block}
.ddi{padding:8px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:13px}
.ddi:hover{background:#1e1e2a}
.ddi-name{color:#e8e4dc}
.ddi-meta{color:#555;font-size:11px;margin-left:6px}
.ddi-tag{font-size:10px;color:#444;background:#1a1a24;padding:2px 6px;border-radius:3px}

/* commodity select */
.comm-select{width:100%;background:#0d0d10;border:1px solid #222230;border-radius:6px;padding:10px 12px;color:#e8e4dc;font-size:14px;outline:none;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23555' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.comm-select:focus{border-color:#333}
.comm-select option{background:#16161f}

/* cargo */
.num-wrap{display:flex;align-items:center;background:#0d0d10;border:1px solid #222230;border-radius:6px;overflow:hidden}
.num-in{flex:1;background:transparent;border:none;padding:10px 12px;color:#e8e4dc;font-size:14px;outline:none}
.num-unit{padding:10px 12px;color:#555;font-size:13px;border-left:1px solid #1a1a24}

/* vessel badge */
.vessel-auto{background:#0d0d10;border:1px solid #1e1e2a;border-radius:6px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between}
.va-name{font-size:14px;font-weight:600;color:#f5c842}
.va-detail{font-size:11px;color:#555;margin-top:2px}
.va-badge{font-size:10px;font-weight:700;color:#555;background:#1a1a24;padding:3px 7px;border-radius:3px;letter-spacing:.5px}

/* calc button */
.calc-btn{width:100%;padding:14px;background:#f5c842;color:#0d0d10;font-size:13px;font-weight:700;letter-spacing:1.5px;border:none;border-radius:6px;cursor:pointer;transition:background .15s}
.calc-btn:hover:not(:disabled){background:#ffd966}
.calc-btn:disabled{background:#1a1a24;color:#333;cursor:not-allowed}

/* route option selector */
.route-opts-wrap{display:none}
.route-opts-wrap.visible{display:block}
.route-opts-label{font-size:11px;font-weight:600;color:#666;letter-spacing:.8px;text-transform:uppercase;margin-bottom:8px}
.route-opts{display:flex;flex-direction:column;gap:6px}
.route-opt{display:flex;align-items:center;gap:12px;padding:10px 14px;background:#0d0d10;border:1px solid #222230;border-radius:6px;cursor:pointer;transition:border-color .15s,background .15s}
.route-opt:hover{background:#13131a;border-color:#333}
.route-opt.selected{border-color:#f5c842;background:#13110a}
.route-opt input[type=radio]{accent-color:#f5c842;width:15px;height:15px;flex-shrink:0;cursor:pointer}
.route-opt-name{font-size:13px;font-weight:600;color:#e8e4dc;flex:1}
.route-opt-nm{font-family:'IBM Plex Mono',monospace;font-size:12px;color:#f5c842;white-space:nowrap}
.route-opt-warn{font-size:10px;color:#e07820;background:#1a1200;border:1px solid #2e2000;padding:2px 6px;border-radius:3px;white-space:nowrap}


/* ── hero bar ── */
.hero-bar{background:#111118;border:1px solid #1e1e2a;border-radius:10px;padding:20px 24px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px}
.hero-item .val{font-family:'IBM Plex Mono',monospace;font-size:24px;font-weight:600;color:#f5c842}
.hero-item .lbl{font-size:11px;color:#555;margin-top:3px;text-transform:uppercase;letter-spacing:.6px}

.route-badge{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.rbadge{font-size:11px;color:#666;background:#111118;border:1px solid #1e1e2a;padding:4px 10px;border-radius:20px}
.rbadge.via{color:#f5c842;border-color:#2a2400}

.warn{background:#1a1200;border:1px solid #2e2000;border-radius:6px;padding:10px 14px;font-size:12px;color:#b88820;margin-bottom:12px}

/* ── section cards ── */
.sec-card{background:#111118;border:1px solid #1e1e2a;border-radius:10px;overflow:hidden;margin-bottom:10px}
.sec-hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;cursor:pointer;user-select:none;transition:background .1s}
.sec-hdr:hover{background:#161620}
.sec-num{font-size:10px;font-weight:700;color:#444;letter-spacing:1px;margin-right:8px;text-transform:uppercase}
.sec-title{font-size:13px;font-weight:600;color:#bbb;letter-spacing:.3px}
.sec-total{font-family:'IBM Plex Mono',monospace;font-size:14px;color:#f5c842}
.sec-chevron{color:#444;font-size:12px;margin-left:8px;transition:transform .2s}
.sec-hdr.open .sec-chevron{transform:rotate(180deg)}
.sec-body{border-top:1px solid #1a1a24;padding:16px 20px;display:none}
.sec-body.open{display:block}

/* param rows */
.param-block{margin-bottom:16px}
.param-block:last-child{margin-bottom:0}
.param-block-title{font-size:10px;font-weight:700;color:#444;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #1a1a24}
.param-row{display:grid;grid-template-columns:180px 1fr auto;align-items:center;gap:10px;padding:5px 0}
.param-lbl{font-size:12px;color:#777}
.param-val-display{font-family:'IBM Plex Mono',monospace;font-size:13px;color:#e8e4dc}
.param-note{font-size:11px;color:#444;font-style:italic;text-align:right}
.param-row.derived .param-lbl{color:#555}
.param-row.derived .param-val-display{color:#aaa}
.param-row.subtotal-row{border-top:1px solid #1a1a24;margin-top:6px;padding-top:10px}
.param-row.subtotal-row .param-lbl{color:#ccc;font-weight:600}
.param-row.subtotal-row .param-val-display{color:#f5c842;font-size:14px}

/* editable inline input */
.p-inline{display:flex;align-items:center;gap:6px}
.p-in{background:#0d0d10;border:1px solid #252535;border-radius:4px;padding:5px 8px;color:#e8e4dc;font-family:'IBM Plex Mono',monospace;font-size:13px;width:100px;outline:none;text-align:right;transition:border-color .15s}
.p-in:focus{border-color:#f5c842;background:#0f0f15}
.p-unit{font-size:11px;color:#555;white-space:nowrap}

/* grand total */
.grand-total{background:#0d0d10;border:1px solid #1e1e2a;border-radius:10px;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;margin-top:4px}
.gt-label{font-size:13px;color:#888}
.gt-val{font-family:'IBM Plex Mono',monospace;font-size:18px;color:#f5c842;font-weight:600}
.gt-permt{font-family:'IBM Plex Mono',monospace;font-size:14px;color:#90d060}

#results{margin-top:24px;display:none}

@media(max-width:640px){.row2{grid-template-columns:1fr}.hero-bar{grid-template-columns:1fr 1fr}.param-row{grid-template-columns:140px 1fr}.param-note{display:none}}
</style>
</head>
<body>
<!-- Loading banner: shown while JSON files are being fetched -->
<div id="loading-banner" style="max-width:900px;margin:40px auto;padding:20px 16px;font-family:'IBM Plex Mono',monospace;font-size:13px;color:#f5c842;text-align:center;letter-spacing:1px">
  LOADING DATA…
</div>

<!-- Main app: hidden until data is loaded -->
<div id="app-content" style="display:none">
<div class="wrap">
  <header>
    <div class="logo">DryFreight <span>Voyage Cost Calculator</span></div>
  </header>

  <!-- INPUT FORM -->
  <div class="form-card">
    <div class="row2">
      <div class="field">
        <label>Load Port</label>
        <div class="port-wrap">
          <input class="port-in" id="loadSearch" placeholder="Search port…" autocomplete="off"
            oninput="filterPorts('load',this.value)" onfocus="openDD('load')" onblur="closeDD('load')">
          <div class="dd" id="loadDD"></div>
        </div>
        <div class="port-meta" id="loadMeta"></div>
      </div>
      <div class="field">
        <label>Discharge Port</label>
        <div class="port-wrap">
          <input class="port-in" id="dischSearch" placeholder="Search port…" autocomplete="off"
            oninput="filterPorts('disch',this.value)" onfocus="openDD('disch')" onblur="closeDD('disch')">
          <div class="dd" id="dischDD"></div>
        </div>
        <div class="port-meta" id="dischMeta"></div>
      </div>
    </div>

    <div class="row2">
      <div class="field">
        <label>Cargo Quantity</label>
        <div class="num-wrap">
          <input class="num-in" id="cargoMt" type="number" value="50000" min="5000" max="200000" step="1000" oninput="onCargoChange()">
          <span class="num-unit">MT</span>
        </div>
      </div>
      <div class="field">
        <label>Commodity</label>
        <select class="comm-select" id="commodity" onchange="onCargoChange()">
          <option value="default">Default / Unknown</option>
        </select>
      </div>
    </div>

    <div class="row2">
      <div class="field" style="grid-column:1/-1">
        <label>Vessel (auto-selected)</label>
        <div class="vessel-auto">
          <div>
            <div class="va-name" id="vaName">Ultramax</div>
            <div class="va-detail" id="vaDetail">~61,000 DWT · 55k–65k MT</div>
          </div>
          <div class="va-badge">AUTO</div>
        </div>
      </div>
    </div>

    <button class="calc-btn" id="calcBtn" onclick="doCalc()" disabled>CALCULATE FREIGHT</button>

    <!-- Route options — shown once both ports are selected -->
    <div class="route-opts-wrap" id="routeOptsWrap">
      <div class="route-opts-label">Select Route</div>
      <div class="route-opts" id="routeOptsList"></div>
    </div>

    <button class="calc-btn" id="calcBtn2" onclick="doCalc()" disabled style="display:none">CALCULATE FREIGHT</button>
  </div>

  <!-- RESULTS -->
  <div id="results">
    <div class="warn" id="warnBox" style="display:none"></div>

    <!-- Hero -->
    <div class="hero-bar">
      <div class="hero-item">
        <div class="val" id="o-permt">—</div>
        <div class="lbl">$/MT</div>
      </div>
      <div class="hero-item">
        <div class="val" id="o-total">—</div>
        <div class="lbl">Total Voyage Cost</div>
      </div>
      <div class="hero-item">
        <div class="val" id="o-days">—</div>
        <div class="lbl" id="o-dayslbl">Total Days</div>
      </div>
    </div>

    <!-- Route info -->
    <div class="route-badge" id="routeBadges"></div>

    <!-- Section 1: TC Hire -->
    <div class="sec-card" id="sec1">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">01</span><span class="sec-title">TC Hire</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-hire">—</span>
          <span class="sec-chevron">▼</span>
        </div>
      </div>
      <div class="sec-body open">

        <!-- Distance -->
        <div class="param-block">
          <div class="param-block-title">Distance &amp; Route</div>
          <div class="param-row derived">
            <span class="param-lbl">Distance</span>
            <span class="param-val-display" id="o-nm">—</span>
            <span class="param-note">Haversine + routing waypoints</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">Route</span>
            <span class="param-val-display" id="o-routedetail">—</span>
            <span class="param-note"></span>
          </div>
        </div>

        <!-- TC Rate -->
        <div class="param-block">
          <div class="param-block-title">TC Rate</div>
          <div class="param-row">
            <span class="param-lbl">Daily hire rate</span>
            <div class="p-inline">
              <input id="p-tcrate" class="p-in" type="number" step="500" oninput="onParamChange()">
              <span class="p-unit">$/day</span>
            </div>
            <span class="param-note" id="o-tcnote">—</span>
          </div>
        </div>

        <!-- Sea days -->
        <div class="param-block">
          <div class="param-block-title">Days at Sea</div>
          <div class="param-row">
            <span class="param-lbl">Laden speed</span>
            <div class="p-inline">
              <input id="p-ladenspd" class="p-in" type="number" step="0.5" oninput="onParamChange()">
              <span class="p-unit">knots</span>
            </div>
            <span class="param-note">Vessel design speed</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Weather factor</span>
            <div class="p-inline">
              <input id="p-wx" class="p-in" type="number" step="0.01" oninput="onParamChange()">
            </div>
            <span class="param-note">1.05 = 5% extra for weather/routing</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">→ Laden days</span>
            <span class="param-val-display" id="o-ladendays">—</span>
            <span class="param-note">nm × weather ÷ (speed × 24)</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Ballast speed</span>
            <div class="p-inline">
              <input id="p-ballspd" class="p-in" type="number" step="0.5" oninput="onParamChange()">
              <span class="p-unit">knots</span>
            </div>
            <span class="param-note"></span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Ballast factor</span>
            <div class="p-inline">
              <input id="p-ball" class="p-in" type="number" step="0.05" oninput="onParamChange()">
            </div>
            <span class="param-note" id="o-ballnote">Ballast leg as fraction of laden distance</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">→ Ballast days</span>
            <span class="param-val-display" id="o-balldays">—</span>
            <span class="param-note">nm × ballast factor ÷ (speed × 24)</span>
          </div>
        </div>

        <!-- Port days -->
        <div class="param-block">
          <div class="param-block-title">Days in Port</div>
          <div class="param-row">
            <span class="param-lbl">Load port rate</span>
            <div class="p-inline">
              <input id="p-lrate" class="p-in" type="number" step="500" oninput="onParamChange()">
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note" id="o-lratenote" style="max-width:160px;text-align:right">—</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Disch. port rate</span>
            <div class="p-inline">
              <input id="p-drate" class="p-in" type="number" step="500" oninput="onParamChange()">
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note" id="o-dratenote" style="max-width:160px;text-align:right">—</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">→ Port days</span>
            <span class="param-val-display" id="o-portdays">—</span>
            <span class="param-note">cargo ÷ rate + 0.75d turn each port</span>
          </div>
          <div class="param-row subtotal-row">
            <span class="param-lbl">Total days</span>
            <span class="param-val-display" id="o-totaldays">—</span>
            <span class="param-note">laden + ballast + port</span>
          </div>
        </div>

      </div><!-- /sec-body -->
    </div><!-- /sec1 -->

    <!-- Section 2: Bunkers -->
    <div class="sec-card" id="sec2">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">02</span><span class="sec-title">Bunkers</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-bunk">—</span>
          <span class="sec-chevron">▼</span>
        </div>
      </div>
      <div class="sec-body open">

        <div class="param-block">
          <div class="param-block-title">Fuel Prices</div>
          <div class="param-row">
            <span class="param-lbl">VLSFO price</span>
            <div class="p-inline">
              <input id="p-vlsfopx" class="p-in" type="number" step="5" oninput="onParamChange()">
              <span class="p-unit">$/MT</span>
            </div>
            <span class="param-note">Very Low Sulphur Fuel Oil (main fuel)</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">MGO price</span>
            <div class="p-inline">
              <input id="p-mgopx" class="p-in" type="number" step="5" oninput="onParamChange()">
              <span class="p-unit">$/MT</span>
            </div>
            <span class="param-note">Marine Gas Oil (ECA zones &amp; port)</span>
          </div>
        </div>

        <div class="param-block">
          <div class="param-block-title">Consumption Rates</div>
          <div class="param-row">
            <span class="param-lbl">Laden consumption</span>
            <div class="p-inline">
              <input id="p-ladencons" class="p-in" type="number" step="1" oninput="onParamChange()">
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note">Main engine laden</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Ballast consumption</span>
            <div class="p-inline">
              <input id="p-ballcons" class="p-in" type="number" step="1" oninput="onParamChange()">
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note">Main engine ballast</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Port consumption</span>
            <div class="p-inline">
              <input id="p-portcons" class="p-in" type="number" step="0.5" oninput="onParamChange()">
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note">Aux. engines in port</span>
          </div>
        </div>

        <div class="param-block">
          <div class="param-block-title">Breakdown</div>
          <div class="param-row derived">
            <span class="param-lbl">VLSFO (sea)</span>
            <span class="param-val-display" id="o-vlsfomt">—</span>
            <span class="param-note" id="o-vlsfocost">—</span>
          </div>
          <div class="param-row derived" id="row-mgo" style="display:none">
            <span class="param-lbl">MGO (ECA zones)</span>
            <span class="param-val-display" id="o-ecomt">—</span>
            <span class="param-note" id="o-ecocost">—</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">MDO (port)</span>
            <span class="param-val-display" id="o-portmdoamt">—</span>
            <span class="param-note" id="o-portmdocost">—</span>
          </div>
          <div class="param-row subtotal-row">
            <span class="param-lbl">Total bunkers</span>
            <span class="param-val-display" id="o-bunk2">—</span>
            <span class="param-note"></span>
          </div>
        </div>

      </div>
    </div>

    <!-- Section 3: Port DAs -->
    <div class="sec-card" id="sec3">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">03</span><span class="sec-title">Port Disbursements (DAs)</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-das">—</span>
          <span class="sec-chevron">▼</span>
        </div>
      </div>
      <div class="sec-body open">
        <div class="param-block">
          <div class="param-block-title">Estimated Disbursement Accounts</div>
          <div class="param-row">
            <span class="param-lbl">Load port DA</span>
            <div class="p-inline">
              <input id="p-daload" class="p-in" type="number" step="1000" oninput="onParamChange()">
              <span class="p-unit">USD</span>
            </div>
            <span class="param-note" id="o-daloadnote">—</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Discharge port DA</span>
            <div class="p-inline">
              <input id="p-dadisch" class="p-in" type="number" step="1000" oninput="onParamChange()">
              <span class="p-unit">USD</span>
            </div>
            <span class="param-note" id="o-dadischnote">—</span>
          </div>
          <div class="param-row subtotal-row">
            <span class="param-lbl">Total DAs</span>
            <span class="param-val-display" id="o-das2">—</span>
            <span class="param-note">Agency, port dues, pilotage, towage</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 4: Canals (conditional) -->
    <div class="sec-card" id="sec4" style="display:none">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">04</span><span class="sec-title">Canal Tolls</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-canals">—</span>
          <span class="sec-chevron">▼</span>
        </div>
      </div>
      <div class="sec-body open" id="sec4body">
        <!-- filled dynamically -->
      </div>
    </div>

    <!-- Section 5: War Risk (conditional) -->
    <div class="sec-card" id="sec5" style="display:none">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">05</span><span class="sec-title">War Risk Insurance</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-war">—</span>
          <span class="sec-chevron">▼</span>
        </div>
      </div>
      <div class="sec-body open" id="sec5body">
        <!-- filled dynamically -->
      </div>
    </div>

    <!-- Section 6: Commission -->
    <div class="sec-card">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num" id="sec6num">06</span><span class="sec-title">Address Commission</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-comm">—</span>
          <span class="sec-chevron">▼</span>
        </div>
      </div>
      <div class="sec-body open">
        <div class="param-block">
          <div class="param-block-title">Brokerage &amp; Address Commission</div>
          <div class="param-row">
            <span class="param-lbl">Commission rate</span>
            <div class="p-inline">
              <input id="p-commpct" class="p-in" type="number" step="0.25" min="0" max="10" oninput="onParamChange()">
              <span class="p-unit">%</span>
            </div>
            <span class="param-note">Applied to total voyage cost</span>
          </div>
          <div class="param-row subtotal-row">
            <span class="param-lbl">Total commission</span>
            <span class="param-val-display" id="o-comm2">—</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Grand Total -->
    <div class="grand-total">
      <div>
        <div class="gt-label">Total Voyage Cost</div>
        <div style="font-size:11px;color:#444;margin-top:2px" id="o-gtcargo">—</div>
      </div>
      <div style="text-align:right">
        <div class="gt-val" id="o-grandtotal">—</div>
        <div class="gt-permt" id="o-grandpermt">—</div>
      </div>
    </div>

  </div><!-- /results -->
</div><!-- /wrap -->
</div><!-- /app-content -->

<script>
// ══════════════════════════════════════════════════
// GLOBAL DATA — populated by loadData() on startup
// ══════════════════════════════════════════════════
let PORTS        = [];
let VESSEL_SPECS = {};
let VESSEL_RANGES= [];
let FIXTURES     = [];
let RN           = {};
let DA           = {};
let PORT_RATE    = {};
let ECA          = new Set();
let WAR          = {};
let TOLLS        = {};
let DEFAULT_BUNKER_PRICES = {vlsfo: 615, mgo: 870};

// Live rates from API — populated after loadData()
// Each entry: {vesselType, originRegion, destinationRegion, rate, confidence, tier, daysOld, scrapedDate, rawLine}
let LIVE_RATES = [];

// Commodity data — populated by loadData()
let COMMODITIES       = {};   // commodity definitions
let REGIONAL_DEFAULTS = {};   // commodity × region rates
let PORT_RATES_COMM   = {};   // port-specific overrides per commodity
let BALLAST_FACTORS   = {};   // ballast factor by discharge region

// ══════════════════════════════════════════════════
// VESSEL HELPERS
// These use the globals populated by loadData()
// ══════════════════════════════════════════════════
// ══════════════════════════════════════════════════
// COMMODITY RATE LOOKUP
// Returns load and discharge rates for a given
// commodity at a specific port, using:
//   1. Port-specific override if available
//   2. Regional default for that commodity
//   3. Commodity base rate
//   4. Legacy portRate fallback
// ══════════════════════════════════════════════════
function getPortRates(port, commodity){
  const comm = commodity || 'default';
  const portName = port.name || '';
  const region   = port.region || '';

  // 1. Port-specific override
  const portOverride = PORT_RATES_COMM[portName];
  if(portOverride){
    const commOverride = portOverride[comm] || portOverride['default'];
    const defOverride  = portOverride['default'];
    // Merge: comm-specific fields override default fields
    const merged = {...(defOverride||{}), ...(commOverride||{})};
    if(merged.load || merged.disch){
      // Fall back any missing side to regional default
      const reg = (REGIONAL_DEFAULTS[region]||{})[comm]
               || (REGIONAL_DEFAULTS[region]||{})['default']
               || {};
      return {
        load:  merged.load  || reg.load  || (COMMODITIES[comm]||{}).loadBase  || 8000,
        disch: merged.disch || reg.disch || (COMMODITIES[comm]||{}).dischBase || 8000,
      };
    }
  }

  // 2. Regional default for this commodity
  const regComm = (REGIONAL_DEFAULTS[region]||{})[comm];
  if(regComm) return { load: regComm.load, disch: regComm.disch };

  // 3. Regional default for 'default' commodity
  const regDef = (REGIONAL_DEFAULTS[region]||{})['default'];
  if(regDef) return { load: regDef.load, disch: regDef.disch };

  // 4. Commodity base rate
  const base = COMMODITIES[comm] || COMMODITIES['default'] || {};
  return { load: base.loadBase||8000, disch: base.dischBase||8000 };
}

function getBallastFactor(dischRegion){
  return BALLAST_FACTORS[dischRegion] || 0.65;
}

function populateCommoditySelect(){
  const sel = document.getElementById('commodity');
  if(!sel || !COMMODITIES) return;
  sel.innerHTML = '';
  for(const [key, val] of Object.entries(COMMODITIES)){
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = val.label;
    sel.appendChild(opt);
  }
}


function vesselForCargo(mt){
  for(const v of VESSEL_RANGES) if(mt>=v.min && mt<=v.max) return v;
  return VESSEL_RANGES[VESSEL_RANGES.length-1];
}

// ── Region neighbours for fuzzy matching ───────────
// Used by both live and fixture matching
function regionNeighbours(r){ return RN[r] || []; }

// ── Score how well two regions match ───────────────
function regionScore(a, b){
  if(a===b) return 40;
  if(regionNeighbours(a).includes(b)) return 20;
  if(regionNeighbours(b).includes(a)) return 12;
  return 0;
}

// ── Match against LIVE_RATES (scraped from HandyBulk) ──
// Returns best live match with its confidence score,
// or null if nothing useful found.
function matchLive(oR, dR, vt){
  let best = null, bestScore = 0;
  for(const r of LIVE_RATES){
    let s = 0;
    s += regionScore(r.originRegion, oR);
    s += regionScore(r.destinationRegion, dR);
    // Vessel type
    if(r.vesselType === vt) s += 20;
    else s += 3; // slight credit for any live rate
    if(s > bestScore){ bestScore = s; best = r; }
  }
  if(!best || bestScore < 15) return null; // not confident enough

  // Adjust confidence downward for non-exact matches
  let conf = best.confidence;
  if(best.originRegion !== oR || best.destinationRegion !== dR) conf = Math.round(conf * 0.75);
  if(best.vesselType   !== vt)                                  conf = Math.round(conf * 0.85);
  conf = Math.max(conf, 15);

  return {
    rate:        best.rate,
    confidence:  conf,
    tier:        best.tier,
    daysOld:     best.daysOld,
    scrapedDate: best.scrapedDate,
    rawLine:     best.rawLine,
    source:      'live',
    matchNote:   best.vesselType+' '+best.originRegion+' → '+best.destinationRegion
                 +' ('+best.daysOld+'d old)',
  };
}

// ── Match against hardcoded FIXTURES (fallback) ────
function matchFixture(oR, dR, vt){
  let best=null, bsc=0, bestF=null;
  for(const f of FIXTURES){
    let s=0;
    s += regionScore(f.oR, oR);
    s += regionScore(f.dR, dR);
    if(f.vt===vt) s+=20; else s+=5;
    if(s>bsc){bsc=s; best=f.rate; bestF=f;}
  }
  return {
    rate:       best||15000,
    confidence: 30,
    tier:       4,
    daysOld:    null,
    scrapedDate:null,
    source:     'fixture',
    matchNote:  bestF ? bestF.vt+' '+bestF.oR+' → '+bestF.dR+' (hardcoded)' : 'default fallback',
  };
}

// ── Main TC rate lookup ─────────────────────────────
// Tries live rates first, falls back to fixtures.
function matchTC(oR, dR, vt){
  const live    = matchLive(oR, dR, vt);
  const fixture = matchFixture(oR, dR, vt);
  const result  = live || fixture;
  return {
    rate:       result.rate,
    confidence: result.confidence,
    tier:       result.tier,
    daysOld:    result.daysOld,
    scrapedDate:result.scrapedDate,
    source:     result.source,
    matchNote:  result.matchNote,
  };
}

// ══════════════════════════════════════════════════
// DATA LOADER
// Fetches all JSON files in parallel, then inits UI.
// Falls back gracefully if a file fails.
// ══════════════════════════════════════════════════
async function loadData(){
  try {
    // Load static JSON files and live API rates in parallel.
    // Live rates failure is non-fatal — we fall back to fixtures.
    // Helper: fetch with timeout
    const fetchJSON = (url, timeoutMs=8000) => {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      return fetch(url, {signal: controller.signal})
        .then(r => { clearTimeout(timer); return r.json(); })
        .catch(() => { clearTimeout(timer); return null; });
    };

    const [portsData, vesselsData, fixturesData, regionsData, commoditiesData, liveData] = await Promise.all([
      fetchJSON('./data/ports.json'),
      fetchJSON('./data/vessels.json'),
      fetchJSON('./data/fixtures.json'),
      fetchJSON('./data/regions.json'),
      fetchJSON('./data/commodities.json'),
      fetchJSON('/api/rates', 5000),
    ]);

    // Core data — these are required
    if(!portsData || !vesselsData || !fixturesData || !regionsData){
      throw new Error('Failed to load core data files. Check that ports.json, vessels.json, fixtures.json and regions.json exist in app/data/');
    }

    // Populate globals
    PORTS         = portsData;
    VESSEL_SPECS  = vesselsData.specs;
    VESSEL_RANGES = vesselsData.ranges;
    FIXTURES      = fixturesData.fixtures;
    RN            = fixturesData.regionNeighbours;
    DA            = regionsData.da;
    PORT_RATE     = regionsData.portRate;
    ECA           = new Set(regionsData.ecaRegions);
    WAR           = regionsData.war;
    TOLLS         = regionsData.tolls;
    DEFAULT_BUNKER_PRICES = regionsData.defaultBunkerPrices;

    // Commodity data — non-fatal if missing
    if(commoditiesData){
      COMMODITIES       = commoditiesData.commodities       || {};
      REGIONAL_DEFAULTS = commoditiesData.regionalDefaults  || {};
      PORT_RATES_COMM   = commoditiesData.portRates         || {};
      BALLAST_FACTORS   = commoditiesData.ballastFactors    || {};
      populateCommoditySelect();
      console.log('[DryFreight] Commodity data loaded');
    } else {
      console.warn('[DryFreight] commodities.json not found — using defaults');
      populateCommoditySelect();
    }

    // Live rates — non-fatal if missing
    if(liveData && liveData.success && liveData.rates && liveData.rates.length > 0){
      LIVE_RATES = liveData.rates;
      console.log(`[DryFreight] Live rates loaded: ${LIVE_RATES.length} routes`);
    } else {
      console.log('[DryFreight] Live rates unavailable — using hardcoded fixtures');
    }

    // Hide loading banner, show app
    document.getElementById('loading-banner').style.display = 'none';
    document.getElementById('app-content').style.display    = 'block';

    // Init port dropdowns
    renderDD('load',  PORTS.slice(0, 80), '');
    renderDD('disch', PORTS.slice(0, 80), '');

  } catch(err) {
    document.getElementById('loading-banner').textContent =
      '⚠ Failed to load data: ' + err.message + '. Please refresh.';
    console.error('DryFreight data load error:', err);
  }
}

// ══════════════════════════════════════════════════
// ROUTING
// ══════════════════════════════════════════════════
function haversine(la1,lo1,la2,lo2){
  const R=3440.065,r=Math.PI/180;
  const dLa=(la2-la1)*r,dLo=(lo2-lo1)*r;
  const a=Math.sin(dLa/2)**2+Math.cos(la1*r)*Math.cos(la2*r)*Math.sin(dLo/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
const WP={
  suez:    {lat:30.0,  lon:32.5},   // Suez Canal entrance
  aden:    {lat:12.5,  lon:44.5},   // Bab-el-Mandeb / Gulf of Aden
  malacca: {lat:1.5,   lon:103.8},  // Strait of Malacca
  gib:     {lat:36.0,  lon:-5.4},   // Gibraltar
  istanbul:{lat:41.0,  lon:28.97},  // Bosphorus
  panama:  {lat:9.0,   lon:-79.5},  // Panama Canal
  cape:    {lat:-34.5, lon:20.0},   // Cape of Good Hope
};

// ── Routing zone for a port ──────────────────────
// Splits the world into 6 zones based on which canals
// a vessel would actually use to get there.
function routeZone(p){
  const r=p.region||'', b=p.basin||'';
  if(r==='W.S.AMERICA') return 'PAC_AMER';
  if(r==='MEXICO' && b==='PACIFIC') return 'PAC_AMER';
  if(['SE.ASIA','CHINA','N.ASIA','AUSTRALIA'].includes(r)) return 'ASIA';
  if(['W.INDIA','E.INDIA','S.INDIA','RED SEA','MIDDLE EAST','E.AFRICA'].includes(r)) return 'INDIAN';
  if(r==='S.AFRICA' && b==='INDIAN') return 'INDIAN';
  if(['N.EUROPE','BALTIC','W.MED','E.MED'].includes(r)) return 'EUR_MED';
  if(r==='BLACK SEA') return 'BLACK';
  if(r==='W.AFRICA' || (r==='S.AFRICA' && b==='ATLANTIC')) return 'W_AFRICA';
  if(['US GULF','US EAST COAST','E.N.AMERICA','E.S.AMERICA','N.S.AMERICA','CARIBBEAN','MEXICO'].includes(r)) return 'ATL_AMER';
  return 'EUR_MED';
}

// ── Distance via Suez with realistic multi-waypoint paths ─────────────
// Haversine alone badly underestimates Suez routes from Europe because
// it cuts straight through the Mediterranean landmass.
// Fix: route explicitly through Gibraltar → Suez → Aden → [Malacca]
function distViaSuez(pA,pB,zA,zB){
  const h=haversine;
  const isEurSide=z=>['EUR_MED','BLACK','W_AFRICA'].includes(z);
  const isEastSide=z=>['INDIAN','ASIA'].includes(z);
  const eurZ=isEurSide(zA)?zA:zB, eastZ=isEastSide(zA)?zA:zB;
  const eurP=isEurSide(zA)?pA:pB, eastP=isEastSide(zA)?pA:pB;

  // Origin → Suez Canal entrance
  let dToSuez;
  if(eurZ==='BLACK'){
    dToSuez = h(eurP.lat,eurP.lon,WP.istanbul.lat,WP.istanbul.lon)
            + h(WP.istanbul.lat,WP.istanbul.lon,WP.gib.lat,WP.gib.lon)
            + h(WP.gib.lat,WP.gib.lon,WP.suez.lat,WP.suez.lon);
  } else {
    // EUR_MED or W_AFRICA: must traverse Mediterranean via Gibraltar
    dToSuez = h(eurP.lat,eurP.lon,WP.gib.lat,WP.gib.lon)
            + h(WP.gib.lat,WP.gib.lon,WP.suez.lat,WP.suez.lon);
  }

  // Suez Canal exit → destination
  let dFromSuez;
  const rEast=eastP.region||'';
  if(rEast==='RED SEA'){
    // Red Sea is a narrow winding corridor — actual sailing ≈ 2× haversine
    dFromSuez = h(WP.suez.lat,WP.suez.lon,eastP.lat,eastP.lon)*2.0;
  } else if(eastZ==='INDIAN'){
    // India / Middle East / E.Africa: Aden is the natural waypoint
    dFromSuez = h(WP.suez.lat,WP.suez.lon,WP.aden.lat,WP.aden.lon)
              + h(WP.aden.lat,WP.aden.lon,eastP.lat,eastP.lon);
  } else {
    // SE.Asia / China / Japan / Australia: Aden → Malacca → destination
    dFromSuez = h(WP.suez.lat,WP.suez.lon,WP.aden.lat,WP.aden.lon)
              + h(WP.aden.lat,WP.aden.lon,WP.malacca.lat,WP.malacca.lon)
              + h(WP.malacca.lat,WP.malacca.lon,eastP.lat,eastP.lon);
  }
  return Math.round((dToSuez+dFromSuez)*1.05);
}

function routedDistance(pA,pB){
  const la1=pA.lat,lo1=pA.lon,la2=pB.lat,lo2=pB.lon;
  const zA=routeZone(pA), zB=routeZone(pB);
  const rA=pA.region||'', rB=pB.region||'';
  const either=set=>set.includes(zA)||set.includes(zB);
  const pair=(a,b)=>(zA===a&&zB===b)||(zA===b&&zB===a);
  let nm, canals=[], warZones=[], routeDesc='Direct';

  const capeNm=()=>Math.round((haversine(la1,lo1,WP.cape.lat,WP.cape.lon)+haversine(WP.cape.lat,WP.cape.lon,la2,lo2))*1.10);
  const panNm =()=>Math.round((haversine(la1,lo1,WP.panama.lat,WP.panama.lon)+haversine(WP.panama.lat,WP.panama.lon,la2,lo2))*1.04);

  // ─ 1. Atlantic Americas ↔ Pacific Americas → Panama ─
  if(pair('ATL_AMER','PAC_AMER')){
    nm=panNm(); canals=['panama']; routeDesc='via Panama Canal';
  }
  // ─ 2. European/Med/Black/W.Africa ↔ Indian Ocean → Suez preferred ─
  else if(either(['EUR_MED','BLACK','W_AFRICA']) && either(['INDIAN'])){
    const s=distViaSuez(pA,pB,zA,zB), c=capeNm();
    if(s<c*1.15){ nm=s; canals=['suez']; routeDesc='via Suez Canal'; }
    else { nm=c; routeDesc='via Cape of Good Hope'; }
  }
  // ─ 3. European/Med/Black/W.Africa ↔ Pacific Asia → Suez (never Panama) ─
  else if(either(['EUR_MED','BLACK','W_AFRICA']) && either(['ASIA'])){
    const s=distViaSuez(pA,pB,zA,zB), c=capeNm();
    if(s<c*1.15){ nm=s; canals=['suez']; routeDesc='via Suez Canal'; }
    else { nm=c; routeDesc='via Cape of Good Hope'; }
  }
  // ─ 4. Atlantic Americas ↔ Indian Ocean → Suez or Cape ─
  else if(pair('ATL_AMER','INDIAN') || pair('ATL_AMER','W_AFRICA')){
    const s=Math.round((haversine(la1,lo1,WP.suez.lat,WP.suez.lon)+haversine(WP.suez.lat,WP.suez.lon,la2,lo2))*1.05);
    const c=capeNm();
    if(s<c*1.12){ nm=s; canals=['suez']; routeDesc='via Suez Canal'; }
    else { nm=c; routeDesc='via Cape of Good Hope'; }
  }
  // ─ 5. Atlantic Americas ↔ Pacific Asia → Panama or Cape only ─
  // (Suez excluded: from Americas it would mean crossing entire Atlantic + Med,
  //  haversine underestimates that badly. In practice always Panama or Cape.)
  else if(pair('ATL_AMER','ASIA')){
    const p=panNm(), c=capeNm();
    if(p<=c*1.05){ nm=p; canals=['panama']; routeDesc='via Panama Canal'; }
    else { nm=c; routeDesc='via Cape of Good Hope'; }
  }
  // ─ 6. Indian Ocean ↔ Pacific Asia → direct (Malacca/Lombok) ─
  else if(either(['INDIAN']) && either(['ASIA'])){
    nm=Math.round(haversine(la1,lo1,la2,lo2)*1.10);
  }
  // ─ 7. Black Sea ↔ Med/Atlantic → via Bosphorus ─
  else if(either(['BLACK']) && either(['EUR_MED','ATL_AMER','W_AFRICA'])){
    nm=Math.round((haversine(la1,lo1,WP.istanbul.lat,WP.istanbul.lon)+haversine(WP.istanbul.lat,WP.istanbul.lon,la2,lo2))*1.10);
    routeDesc='via Bosphorus';
  }
  // ─ 8. Same basin / regional ─
  else {
    nm=Math.round(haversine(la1,lo1,la2,lo2)*1.10);
  }

  // War zone overlays
  if(rA==='RED SEA'||rB==='RED SEA') warZones.push('redsea');
  if(canals.includes('suez') && either(['INDIAN','ASIA'])){
    if(!warZones.includes('redsea')) warZones.push('redsea');
  }
  if(rA==='BLACK SEA'||rB==='BLACK SEA') warZones.push('blacksea');

  return {nm, canals, warZones, routeDesc};
}

// ══════════════════════════════════════════════════
// ROUTE OPTIONS
// Returns all realistic routes for a port pair,
// with distances and war zone flags.
// Used to populate the route selector UI.
// ══════════════════════════════════════════════════
function routeOptions(pA, pB){
  const zA = routeZone(pA), zB = routeZone(pB);
  const rA = pA.region||'', rB = pB.region||'';
  const either = set => set.includes(zA) || set.includes(zB);
  const pair   = (a,b) => (zA===a&&zB===b)||(zA===b&&zB===a);

  const capeNm = () => Math.round((haversine(pA.lat,pA.lon,WP.cape.lat,WP.cape.lon)+haversine(WP.cape.lat,WP.cape.lon,pB.lat,pB.lon))*1.10);
  const panNm  = () => Math.round((haversine(pA.lat,pA.lon,WP.panama.lat,WP.panama.lon)+haversine(WP.panama.lat,WP.panama.lon,pB.lat,pB.lon))*1.04);
  const suezNm = () => distViaSuez(pA, pB, zA, zB);

  const opts = [];

  // ─ Atlantic Americas ↔ Pacific Americas → Panama + Cape ─
  if(pair('ATL_AMER','PAC_AMER')){
    opts.push({key:'panama', label:'Via Panama Canal',        nm:panNm(),  canals:['panama'], warZones:[]});
    opts.push({key:'cape',   label:'Via Cape of Good Hope',   nm:capeNm(), canals:[],         warZones:[]});
  }
  // ─ Europe/Med/Black/W.Africa ↔ Indian or Asia → Suez + Cape ─
  else if((either(['EUR_MED','BLACK','W_AFRICA']) && either(['INDIAN','ASIA']))){
    const s = suezNm(), c = capeNm();
    const suezWar = [];
    if(!['W.INDIA','E.INDIA','S.INDIA','MIDDLE EAST'].includes(rA) &&
       !['W.INDIA','E.INDIA','S.INDIA','MIDDLE EAST'].includes(rB)){
      suezWar.push('redsea'); // transits Red Sea
    }
    if(rA==='RED SEA'||rB==='RED SEA') suezWar.push('redsea');
    opts.push({key:'suez',  label:'Via Suez Canal',          nm:s, canals:['suez'], warZones:[...new Set(suezWar)]});
    opts.push({key:'cape',  label:'Via Cape of Good Hope',   nm:c, canals:[],       warZones:[]});
  }
  // ─ Atlantic Americas ↔ Asia → Panama + Cape ─
  else if(pair('ATL_AMER','ASIA')){
    opts.push({key:'panama', label:'Via Panama Canal',        nm:panNm(),  canals:['panama'], warZones:[]});
    opts.push({key:'cape',   label:'Via Cape of Good Hope',   nm:capeNm(), canals:[],         warZones:[]});
  }
  // ─ Atlantic Americas ↔ Indian → Suez + Cape ─
  else if(pair('ATL_AMER','INDIAN') || pair('ATL_AMER','W_AFRICA')){
    const s = Math.round((haversine(pA.lat,pA.lon,WP.suez.lat,WP.suez.lon)+haversine(WP.suez.lat,WP.suez.lon,pB.lat,pB.lon))*1.05);
    const c = capeNm();
    opts.push({key:'suez',  label:'Via Suez Canal',          nm:s, canals:['suez'], warZones:['redsea']});
    opts.push({key:'cape',  label:'Via Cape of Good Hope',   nm:c, canals:[],       warZones:[]});
  }
  // ─ All other routes → single direct option ─
  else {
    const {nm, canals, warZones, routeDesc} = routedDistance(pA, pB);
    opts.push({key:'direct', label:routeDesc==='Direct'?'Direct sailing':routeDesc, nm, canals, warZones});
  }

  // Add Black Sea war zone to any route touching Black Sea
  for(const o of opts){
    if(rA==='BLACK SEA'||rB==='BLACK SEA'){
      if(!o.warZones.includes('blacksea')) o.warZones.push('blacksea');
    }
  }

  return opts;
}

// ── Build and show the route selector UI ───────────
function updateRouteSelector(){
  const lp = portSel.load, dp = portSel.disch;
  const wrap = document.getElementById('routeOptsWrap');
  const list = document.getElementById('routeOptsList');
  const btn  = document.getElementById('calcBtn');
  const btn2 = document.getElementById('calcBtn2');

  if(!lp || !dp){
    wrap.classList.remove('visible');
    btn.style.display = 'block';
    btn2.style.display = 'none';
    return;
  }

  const opts = routeOptions(lp, dp);

  // If only one option, no selector needed — just use it directly
  if(opts.length <= 1){
    wrap.classList.remove('visible');
    btn.style.display = 'block';
    btn2.style.display = 'none';
    return;
  }

  // Multiple options — show selector, move button below it
  btn.style.display  = 'none';
  btn2.style.display = 'block';
  wrap.classList.add('visible');

  // Find currently selected key (preserve selection on port re-pick)
  const currentKey = document.querySelector('.route-opt.selected')?.dataset?.key || opts[0].key;

  list.innerHTML = opts.map((o, i) => {
    const isSelected = o.key === currentKey || (currentKey === opts[0].key && i === 0 && !document.querySelector('.route-opt.selected'));
    const warnHtml = o.warZones.includes('redsea')
      ? '<span class="route-opt-warn">⚠ Red Sea war risk</span>' : '';
    return `<label class="route-opt${isSelected?' selected':''}" data-key="${o.key}" onclick="selectRoute(this)">
      <input type="radio" name="routeOpt" value="${o.key}"${isSelected?' checked':''}>
      <span class="route-opt-name">${o.label}</span>
      <span class="route-opt-nm">${o.nm.toLocaleString()} nm</span>
      ${warnHtml}
    </label>`;
  }).join('');
}

function selectRoute(el){
  document.querySelectorAll('.route-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  el.querySelector('input').checked = true;
}

// ── Get the currently selected route option ────────
function getSelectedRoute(lp, dp){
  const key = document.querySelector('.route-opt.selected')?.dataset?.key
           || document.querySelector('.route-opt')?.dataset?.key;
  const opts = routeOptions(lp, dp);
  return opts.find(o => o.key === key) || opts[0];
}


function compute(lp, dp, cargoMt, routeOpt){
  const vr = vesselForCargo(cargoMt);
  const sp = VESSEL_SPECS[vr.v];
  const tcMatch = matchTC(lp.region, dp.region, vr.v);
  const commodity = document.getElementById('commodity')?.value || 'default';

  // Use the user-selected route if provided, otherwise auto-route
  const route = routeOpt || routedDistance(lp, dp);
  const nm        = route.nm;
  const canals    = route.canals;
  const warZones  = route.warZones;
  const routeDesc = route.label || route.routeDesc || 'Direct';

  const canalCosts={};
  for(const c of canals) canalCosts[c]=(TOLLS[c]||{})[vr.v]||0;
  const warCosts={};
  for(const z of warZones) warCosts[z]=Math.round((WAR[z].hull)+(cargoMt*WAR[z].cargoPerMt));

  // Commodity-aware port rates (port-specific → regional → base)
  const loadRates  = getPortRates(lp, commodity);
  const dischRates = getPortRates(dp, commodity);

  // Ballast factor based on discharge region (where vessel repositions from)
  const ballastFactor = getBallastFactor(dp.region);

  return {vr, sp,
          tcRate: tcMatch.rate, tcMatch,
          nm, canals, warZones, canalCosts, warCosts, routeDesc,
          commodity,
          lRate: loadRates.load,   lRateDisch: loadRates.disch,
          dRate: dischRates.disch, dRateLoad:  dischRates.load,
          ballastFactor,
          daLoad: DA[lp.region]||40000, daDisch: DA[dp.region]||40000};
}

// ══════════════════════════════════════════════════
// RECOMPUTE FROM EDIT STATE
// ══════════════════════════════════════════════════
function recompute(s){
  // Days
  const ladenDays = s.nm * s.wxFactor / (s.ladenKn * 24);
  const ballDays  = s.nm * s.ballFactor / (s.ballKn * 24);
  const portDays  = (s.cargoMt/s.lRate + 0.75) + (s.cargoMt/s.dRate + 0.75);
  const totalDays = ladenDays + ballDays + portDays;
  // Hire
  const hire = s.tcRate * totalDays;
  // Bunkers
  const ecaLd = ECA.has(s.lp.region)?1.5:0;
  const ecaDd = ECA.has(s.dp.region)?1.5:0;
  const ecaDays = Math.min(ladenDays+ballDays, ecaLd+ecaDd);
  const mainDays = Math.max(0, ladenDays+ballDays-ecaDays);
  const seaDays = ladenDays+ballDays||1;
  const vlsfoQt  = Math.round(mainDays*(s.ladenCons*ladenDays+s.ballCons*ballDays)/seaDays);
  const ecaMgoQt = Math.round(ecaDays*s.ladenCons);
  const portMdoQt= Math.round(portDays*s.portCons);
  const bunkers = Math.round(vlsfoQt*s.vlsfoPrice + ecaMgoQt*s.mgoPrice + portMdoQt*s.mgoPrice);
  // DAs
  const portDAs = s.daLoad + s.daDisch;
  // Canals
  let canalCost=0; for(const k in s.canalCosts) canalCost+=Number(s.canalCosts[k])||0;
  // War
  let warCost=0; for(const k in s.warCosts) warCost+=Number(s.warCosts[k])||0;
  // Commission
  const subtotal = hire+bunkers+portDAs+canalCost+warCost;
  const commission = subtotal * s.commPct/100;
  const total = subtotal + commission;
  const perMt = total / s.cargoMt;
  return {ladenDays,ballDays,portDays,totalDays,hire,vlsfoQt,ecaMgoQt,portMdoQt,bunkers,portDAs,canalCost,warCost,commission,total,perMt,ecaDays};
}

// ══════════════════════════════════════════════════
// EDIT STATE
// ══════════════════════════════════════════════════
let editState = null;

// ══════════════════════════════════════════════════
// PORT SEARCH UI
// ══════════════════════════════════════════════════
let portSel={load:null,disch:null};
function filterPorts(wh,q){
  const ql=q.toLowerCase().trim();
  const list=ql?PORTS.filter(p=>p.name.toLowerCase().includes(ql)||p.country.toLowerCase().includes(ql)):PORTS;
  renderDD(wh,list.slice(0,80),ql);
  document.getElementById(wh+'DD').classList.add('open');
}
function openDD(wh){
  if(!document.getElementById(wh+'Search').classList.contains('chosen'))
    renderDD(wh,PORTS.slice(0,80),'');
  document.getElementById(wh+'DD').classList.add('open');
}
function closeDD(wh){setTimeout(()=>document.getElementById(wh+'DD').classList.remove('open'),260);}
function renderDD(wh,list,q){
  const el=document.getElementById(wh+'DD'); el.innerHTML='';
  if(!list.length){el.innerHTML='<div class="ddi"><span class="ddi-meta">No ports found</span></div>';return;}
  list.forEach(p=>{
    const d=document.createElement('div');d.className='ddi';
    const nm=q?p.name.replace(new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<b style="color:#f5c842">$1</b>'):p.name;
    d.innerHTML=`<span><span class="ddi-name">${nm}</span><span class="ddi-meta">&nbsp;${p.country}</span></span><span class="ddi-tag">${p.region||''}</span>`;
    d.onmousedown=e=>{e.preventDefault();pickPort(wh,p);};
    el.appendChild(d);
  });
}
function pickPort(wh,p){
  portSel[wh]=p;
  const si=document.getElementById(wh+'Search');
  si.value=p.name; si.classList.add('chosen');
  document.getElementById(wh+'Meta').textContent=p.country+' · '+p.region;
  document.getElementById(wh+'DD').classList.remove('open');
  checkReady();
}
function checkReady(){
  const ready = !!(portSel.load && portSel.disch);
  document.getElementById('calcBtn').disabled  = !ready;
  document.getElementById('calcBtn2').disabled = !ready;
  updateRouteSelector();
}
function onCargoChange(){
  const mt=parseInt(document.getElementById('cargoMt').value)||50000;
  const vr=vesselForCargo(mt);
  document.getElementById('vaName').textContent=vr.label;
  document.getElementById('vaDetail').textContent=vr.desc;
  // No auto-recalc — user must click Calculate
}

// ══════════════════════════════════════════════════
// SECTION TOGGLE
// ══════════════════════════════════════════════════
function toggleSec(hdr){
  hdr.classList.toggle('open');
  hdr.nextElementSibling.classList.toggle('open');
}

// ══════════════════════════════════════════════════
// FORMAT HELPERS
// ══════════════════════════════════════════════════
const Fm=n=>'$'+Math.round(n).toLocaleString('en-US');
const Fd=n=>n.toFixed(1);
const Fn=n=>n.toLocaleString('en-US');

// ══════════════════════════════════════════════════
// MAIN CALCULATE
// ══════════════════════════════════════════════════
function doCalc(){
  if(!portSel.load||!portSel.disch) return;
  const cargoMt=parseInt(document.getElementById('cargoMt').value)||50000;
  // Get the user-selected route (or first option if selector not shown)
  const routeOpt = getSelectedRoute(portSel.load, portSel.disch);
  const C=compute(portSel.load, portSel.disch, cargoMt, routeOpt);

  // Build edit state with defaults from computed
  editState={
    lp: portSel.load,
    dp: portSel.disch,
    cargoMt,
    vr: C.vr,
    nm: C.nm,
    routeDesc: C.routeDesc,
    canals: C.canals,
    warZones: C.warZones,
    tcMatch: C.tcMatch,
    tcRate: C.tcRate,
    ladenKn: C.sp.ladenKn,
    ballKn: C.sp.ballKn,
    wxFactor: 1.05,
    ballFactor: C.ballastFactor,
    lRate: C.lRate,
    dRate: C.dRate,
    vlsfoPrice: 615,
    mgoPrice: 870,
    ladenCons: C.sp.ladenCons,
    ballCons: C.sp.ballCons,
    portCons: C.sp.portCons,
    daLoad: C.daLoad,
    daDisch: C.daDisch,
    canalCosts: {...C.canalCosts},
    warCosts: {...C.warCosts},
    commPct: 3.75,
  };

  // Populate route badges
  const rb=document.getElementById('routeBadges');
  rb.innerHTML=`<span class="rbadge">${portSel.load.name} → ${portSel.disch.name}</span>`
    +(C.canals.length?`<span class="rbadge via">${C.routeDesc}</span>`:`<span class="rbadge">${C.routeDesc}</span>`)
    +`<span class="rbadge">${Fn(C.nm)} nm</span>`
    +`<span class="rbadge">${C.vr.label}</span>`;

  // Warnings
  const warns=[];
  if(C.warZones.includes('redsea')) warns.push('⚠ Red Sea routing — Houthi threat area. War risk premium included. Many vessels diverting via Cape (+3,500 nm).');
  if(C.warZones.includes('blacksea')) warns.push('⚠ Black Sea routing — war risk premium included.');
  const wb=document.getElementById('warnBox');
  wb.style.display=warns.length?'block':'none';
  wb.innerHTML=warns.join('<br>');

  // Populate static info spans
  document.getElementById('o-nm').textContent=Fn(C.nm)+' nm';
  document.getElementById('o-routedetail').textContent=C.routeDesc;
  document.getElementById('o-daloadnote').textContent=portSel.load.name+' ('+portSel.load.region+')';
  document.getElementById('o-dadischnote').textContent=portSel.disch.name+' ('+portSel.disch.region+')';

  // TC rate source + confidence note
  (function(){
    const m = C.tcMatch;
    const noteEl = document.getElementById('o-tcnote');
    if(!noteEl) return;

    // Confidence colour
    const col = m.confidence >= 80 ? '#90d060'   // green  — Tier 1 live
              : m.confidence >= 60 ? '#f5c842'   // yellow — Tier 2 live
              : m.confidence >= 40 ? '#e07820'   // orange — Tier 3 / near match
              :                      '#666';     // grey   — fixture fallback

    let label = '';
    if(m.source === 'live'){
      const d = m.daysOld === 0 ? 'today'
              : m.daysOld === 1 ? '1 day ago'
              : m.daysOld + ' days ago';
      label = `Market rate scraped ${d}`;
    } else {
      label = 'Hardcoded reference rate';
    }

    noteEl.innerHTML =
      `<span style="color:${col};font-weight:700">${m.confidence}/100</span>`
      + `&nbsp;&nbsp;${label}`
      + `<br><span style="color:#444;font-size:10px">${m.matchNote}</span>`;
  })();

  // Populate editable inputs
  setInput('p-tcrate',    C.tcRate);
  setInput('p-ladenspd',  C.sp.ladenKn);
  setInput('p-ballspd',   C.sp.ballKn);
  setInput('p-wx',        1.05);
  setInput('p-ball',      C.ballastFactor);
  setInput('p-lrate',     C.lRate);
  setInput('p-drate',     C.dRate);
  setInput('p-vlsfopx',   615);
  setInput('p-mgopx',     870);
  setInput('p-ladencons', C.sp.ladenCons);
  setInput('p-ballcons',  C.sp.ballCons);
  setInput('p-portcons',  C.sp.portCons);
  setInput('p-daload',    C.daLoad);
  setInput('p-dadisch',   C.daDisch);
  setInput('p-commpct',   3.75);

  // Update ballast factor note to show discharge region
  const ballNote = document.getElementById('o-ballnote');
  if(ballNote) ballNote.textContent = dp.region + ' discharge region';

  // Update load/discharge rate notes to show commodity + source
  const commLabel = (COMMODITIES[C.commodity]||{}).label || 'Default';
  const lRateNote = document.getElementById('o-lratenote');
  const dRateNote = document.getElementById('o-dratenote');
  const portOverrideL = PORT_RATES_COMM[lp.name];
  const portOverrideD = PORT_RATES_COMM[dp.name];
  if(lRateNote) lRateNote.textContent = (portOverrideL ? lp.name + ' terminal rate' : lp.region + ' regional rate') + ' · ' + commLabel;
  if(dRateNote) dRateNote.textContent = (portOverrideD ? dp.name + ' terminal rate' : dp.region + ' regional rate') + ' · ' + commLabel;

  // Handle canal section
  const sec4=document.getElementById('sec4');
  if(C.canals.length>0){
    sec4.style.display='block';
    let html='<div class="param-block"><div class="param-block-title">Toll by Vessel Class</div>';
    for(const c of C.canals){
      const cname=c.charAt(0).toUpperCase()+c.slice(1);
      html+=`<div class="param-row">
        <span class="param-lbl">${cname} Canal toll</span>
        <div class="p-inline"><input id="p-canal-${c}" class="p-in" type="number" step="5000" value="${C.canalCosts[c]||0}" oninput="onParamChange()"><span class="p-unit">USD</span></div>
        <span class="param-note">${C.vr.label} class rate</span>
      </div>`;
    }
    html+=`<div class="param-row subtotal-row"><span class="param-lbl">Total canal tolls</span><span class="param-val-display" id="o-canals2">—</span></div>`;
    html+='</div>';
    document.getElementById('sec4body').innerHTML=html;
  } else {
    sec4.style.display='none';
  }

  // Handle war section
  const sec5=document.getElementById('sec5');
  if(C.warZones.length>0){
    sec5.style.display='block';
    let html='<div class="param-block"><div class="param-block-title">War Risk Premium</div>';
    for(const z of C.warZones){
      const w=WAR[z];
      html+=`<div class="param-row">
        <span class="param-lbl">${w.label}</span>
        <div class="p-inline"><input id="p-war-${z}" class="p-in" type="number" step="5000" value="${C.warCosts[z]||0}" oninput="onParamChange()"><span class="p-unit">USD</span></div>
        <span class="param-note">Hull + cargo (${w.cargoPerMt*100}¢/MT)</span>
      </div>`;
    }
    html+=`<div class="param-row subtotal-row"><span class="param-lbl">Total war risk</span><span class="param-val-display" id="o-war2">—</span></div>`;
    html+='</div>';
    document.getElementById('sec5body').innerHTML=html;
  } else {
    sec5.style.display='none';
  }

  // Update section numbers for commission
  let secIdx=4;
  if(C.canals.length) secIdx++;
  if(C.warZones.length) secIdx++;
  document.getElementById('sec6num').textContent='0'+secIdx;

  // Show results
  document.getElementById('results').style.display='block';

  // Run first calculation pass
  onParamChange();

  document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
}

function setInput(id,val){
  const el=document.getElementById(id);
  if(el) el.value=val;
}

// ══════════════════════════════════════════════════
// PARAM CHANGE — read inputs, recompute, update spans
// ══════════════════════════════════════════════════
function onParamChange(){
  if(!editState) return;
  // Read all inputs into editState
  editState.tcRate    = rv('p-tcrate',    editState.tcRate);
  editState.ladenKn   = rv('p-ladenspd',  editState.ladenKn);
  editState.ballKn    = rv('p-ballspd',   editState.ballKn);
  editState.wxFactor  = rv('p-wx',        editState.wxFactor);
  editState.ballFactor= rv('p-ball',      editState.ballFactor);
  editState.lRate     = rv('p-lrate',     editState.lRate);
  editState.dRate     = rv('p-drate',     editState.dRate);
  editState.vlsfoPrice= rv('p-vlsfopx',   editState.vlsfoPrice);
  editState.mgoPrice  = rv('p-mgopx',     editState.mgoPrice);
  editState.ladenCons = rv('p-ladencons', editState.ladenCons);
  editState.ballCons  = rv('p-ballcons',  editState.ballCons);
  editState.portCons  = rv('p-portcons',  editState.portCons);
  editState.daLoad    = rv('p-daload',    editState.daLoad);
  editState.daDisch   = rv('p-dadisch',   editState.daDisch);
  editState.commPct   = rv('p-commpct',   editState.commPct);
  for(const c of editState.canals)
    editState.canalCosts[c]=rv('p-canal-'+c, editState.canalCosts[c]||0);
  for(const z of editState.warZones)
    editState.warCosts[z]=rv('p-war-'+z, editState.warCosts[z]||0);

  const R=recompute(editState);

  // Hero
  set('o-permt',    R.perMt.toFixed(2));
  set('o-total',    Fm(R.total));
  set('o-days',     Fd(R.totalDays)+'d');
  set('o-dayslbl',  'Total Days · '+editState.vr.label);

  // Sec 1: TC Hire
  set('o-hire',      Fm(R.hire));
  set('o-ladendays', Fd(R.ladenDays)+' d');
  set('o-balldays',  Fd(R.ballDays)+' d');
  set('o-portdays',  Fd(R.portDays)+' d');
  set('o-totaldays', Fd(R.totalDays)+' d  ('+Fd(R.ladenDays)+' laden + '+Fd(R.ballDays)+' ballast + '+Fd(R.portDays)+' port)');

  // Sec 2: Bunkers
  set('o-bunk',  Fm(R.bunkers));
  set('o-bunk2', Fm(R.bunkers));
  set('o-vlsfomt',    Fn(R.vlsfoQt)+' MT');
  set('o-vlsfocost',  Fm(R.vlsfoQt*editState.vlsfoPrice));
  set('o-portmdoamt', Fn(R.portMdoQt)+' MT');
  set('o-portmdocost',Fm(R.portMdoQt*editState.mgoPrice));
  const rowMgo=document.getElementById('row-mgo');
  if(rowMgo){
    rowMgo.style.display=R.ecaDays>0?'grid':'none';
    set('o-ecomt',   Fn(R.ecaMgoQt)+' MT');
    set('o-ecocost', Fm(R.ecaMgoQt*editState.mgoPrice));
  }

  // Sec 3: DAs
  set('o-das',  Fm(R.portDAs));
  set('o-das2', Fm(R.portDAs));

  // Sec 4: Canals
  if(editState.canals.length){
    set('o-canals', Fm(R.canalCost));
    if(document.getElementById('o-canals2')) set('o-canals2', Fm(R.canalCost));
  }

  // Sec 5: War
  if(editState.warZones.length){
    set('o-war', Fm(R.warCost));
    if(document.getElementById('o-war2')) set('o-war2', Fm(R.warCost));
  }

  // Sec 6: Commission
  set('o-comm',  Fm(R.commission));
  set('o-comm2', Fm(R.commission));

  // Grand total
  set('o-grandtotal', Fm(R.total));
  set('o-grandpermt', R.perMt.toFixed(2)+' $/MT');
  set('o-gtcargo', Fn(editState.cargoMt)+' MT · '+editState.vr.label);
}

function rv(id, fallback){
  const el=document.getElementById(id);
  if(!el) return fallback;
  const v=parseFloat(el.value);
  return isNaN(v)||v<=0 ? fallback : v;
}
function set(id,val){
  const el=document.getElementById(id);
  if(el) el.textContent=val;
}

// ══════════════════════════════════════════════════
// INIT
// ══════════════════════════════════════════════════

// ══════════════════════════════════════════════════
// BOOT
// ══════════════════════════════════════════════════
loadData();
</script>
</body>
</html>