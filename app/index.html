<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DryFreight Calculator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Sans+Condensed:wght@700&family=IBM+Plex+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{background:#f7f5f2;color:#222222;font-family:'IBM Plex Sans',system-ui,sans-serif;min-height:100vh}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
nav{background:#fff;border-bottom:1px solid #e8e2da;position:sticky;top:0;z-index:200}
.nav-inner{max-width:900px;margin:0 auto;padding:0 16px;height:52px;display:flex;align-items:center;justify-content:space-between}
.nav-logo{font-family:'IBM Plex Sans Condensed',sans-serif;font-size:20px;font-weight:700;color:#e8384f;letter-spacing:.5px;text-decoration:none}
.nav-links{display:flex;gap:4px;align-items:center}
.nav-link{font-size:13px;font-weight:500;color:#888;padding:6px 12px;border-radius:6px;cursor:pointer;transition:all .15s;border:none;background:none;text-decoration:none}
.nav-link:hover{color:#222;background:#f5f2ee}
.nav-link.active{color:#e8384f;background:#fff3f4}
.beta-badge{background:#fff3f4;border:1px solid #fac5cb;color:#e8384f;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;border-radius:20px}

.wrap{max-width:900px;margin:0 auto;padding:24px 16px 80px}

/* ‚îÄ‚îÄ PAGE SECTIONS ‚îÄ‚îÄ */
.page-section{display:none}
.page-section.active{display:block}

/* ‚îÄ‚îÄ HERO INTRO (calculator page top) ‚îÄ‚îÄ */
.calc-intro{padding:28px 0 20px}
.calc-intro h1{font-family:'IBM Plex Sans Condensed',sans-serif;font-size:28px;font-weight:700;color:#222;line-height:1.2;margin-bottom:6px}
.calc-intro p{font-size:14px;color:#999;line-height:1.5}

/* freight type selector */
.freight-tabs{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap}
.freight-tab{display:flex;align-items:center;gap:7px;padding:8px 16px;border-radius:8px;border:1.5px solid #e0dbd4;background:#fff;font-size:13px;font-weight:500;color:#666;cursor:pointer;transition:all .15s}
.freight-tab:hover{border-color:#ccc;color:#333}
.freight-tab.active{border-color:#e8384f;background:#fff3f4;color:#e8384f;font-weight:600}
.freight-tab .ft-icon{font-size:16px;line-height:1}
.freight-dev-msg{background:#fff8f0;border:1px solid #fde8c8;border-radius:10px;padding:28px 24px;text-align:center;display:none}
.freight-dev-msg h3{font-size:16px;font-weight:600;color:#c47208;margin-bottom:8px}
.freight-dev-msg p{font-size:13px;color:#a06010;line-height:1.6}
.freight-dev-msg .dev-icon{font-size:36px;margin-bottom:12px}

/* ‚îÄ‚îÄ form card ‚îÄ‚îÄ */
.form-card{background:#fff;border:1px solid #e0dbd4;border-radius:12px;padding:24px;display:flex;flex-direction:column;gap:20px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.field label{display:block;font-size:11px;font-weight:600;color:#aaa;letter-spacing:.8px;text-transform:uppercase;margin-bottom:6px}

/* port search */
.port-wrap{position:relative}
.port-in{width:100%;background:#faf9f7;border:1.5px solid #e0dbd4;border-radius:8px;padding:10px 12px;color:#222;font-size:14px;outline:none;transition:border-color .15s}
.port-in:focus{border-color:#e8384f;background:#fff}
.port-in.chosen{border-color:#b7dda8;color:#2d7a1a}
.port-meta{font-size:11px;color:#bbb;margin-top:4px;min-height:16px}
.dd{position:absolute;top:calc(100% + 4px);left:0;right:0;background:#fff;border:1.5px solid #e0dbd4;border-radius:8px;max-height:220px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 16px rgba(0,0,0,.08)}
.dd.open{display:block}
.ddi{padding:8px 12px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;font-size:13px}
.ddi:hover{background:#faf9f7}
.ddi-name{color:#222}
.ddi-meta{color:#bbb;font-size:11px;margin-left:6px}
.ddi-tag{font-size:10px;color:#999;background:#f5f3f0;padding:2px 6px;border-radius:3px}

/* commodity select */
.comm-select{width:100%;background:#faf9f7;border:1.5px solid #e0dbd4;border-radius:8px;padding:10px 12px;color:#222;font-size:14px;outline:none;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23aaa' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.comm-select:focus{border-color:#e8384f}
.comm-select option{background:#fff}

/* cargo number input */
.num-wrap{display:flex;align-items:center;background:#faf9f7;border:1.5px solid #e0dbd4;border-radius:8px;overflow:hidden}
.num-in{flex:1;background:transparent;border:none;padding:10px 12px;color:#222;font-size:14px;outline:none;-moz-appearance:textfield}
.num-in::-webkit-outer-spin-button,.num-in::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.num-unit{padding:10px 12px;color:#bbb;font-size:13px;border-left:1px solid #ede8e2}

/* vessel badge */
.vessel-auto{background:#faf9f7;border:1.5px solid #e0dbd4;border-radius:8px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between}
.va-name{font-size:14px;font-weight:600;color:#e8384f}
.va-detail{font-size:11px;color:#bbb;margin-top:2px}
.va-badge{font-size:10px;font-weight:700;color:#aaa;background:#f0ece7;padding:3px 7px;border-radius:3px;letter-spacing:.5px}

/* calc button */
.calc-btn{width:100%;padding:14px;background:#e8384f;color:#fff;font-size:13px;font-weight:700;letter-spacing:1.5px;border:none;border-radius:8px;cursor:pointer;transition:background .15s}
.calc-btn:hover:not(:disabled){background:#d42d43}
.calc-btn:disabled{background:#ede8e2;color:#bbb;cursor:not-allowed}

/* route option selector */
.route-opts-wrap{display:none}
.route-opts-wrap.visible{display:block}
.route-opts-label{font-size:11px;font-weight:600;color:#aaa;letter-spacing:.8px;text-transform:uppercase;margin-bottom:8px}
.route-opts{display:flex;flex-direction:column;gap:6px}
.route-opt{display:flex;align-items:center;gap:12px;padding:10px 14px;background:#faf9f7;border:1.5px solid #e0dbd4;border-radius:8px;cursor:pointer;transition:border-color .15s,background .15s}
.route-opt:hover{background:#f5f3f0;border-color:#ccc}
.route-opt.selected{border-color:#e8384f;background:#fff6f7}
.route-opt input[type=radio]{accent-color:#e8384f;width:15px;height:15px;flex-shrink:0;cursor:pointer}
.route-opt-name{font-size:13px;font-weight:600;color:#222;flex:1}
.route-opt-nm{font-family:'IBM Plex Mono',monospace;font-size:12px;color:#e8384f;white-space:nowrap}
.route-opt-warn{font-size:10px;color:#c47208;background:#fff8f0;border:1px solid #fde8c8;padding:2px 6px;border-radius:3px;white-space:nowrap}

/* ‚îÄ‚îÄ hero bar ‚îÄ‚îÄ */
.hero-bar{background:#fff;border:1px solid #e0dbd4;border-radius:12px;padding:20px 24px;display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.hero-item .val{font-family:'IBM Plex Mono',monospace;font-size:26px;font-weight:600;color:#e8384f}
.hero-item .lbl{font-size:11px;color:#bbb;margin-top:3px;text-transform:uppercase;letter-spacing:.6px}

.route-badge{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.rbadge{font-size:11px;color:#999;background:#fff;border:1px solid #e0dbd4;padding:4px 10px;border-radius:20px}
.rbadge.via{color:#e8384f;border-color:#fac5cb;background:#fff6f7}

.warn{background:#fff8f0;border:1px solid #fde8c8;border-radius:8px;padding:10px 14px;font-size:12px;color:#c47208;margin-bottom:12px}

/* ‚îÄ‚îÄ section cards ‚îÄ‚îÄ */
.sec-card{background:#fff;border:1px solid #e0dbd4;border-radius:12px;overflow:hidden;margin-bottom:10px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.sec-hdr{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;cursor:pointer;user-select:none;transition:background .1s}
.sec-hdr:hover{background:#faf9f7}
.sec-num{font-size:10px;font-weight:700;color:#ccc;letter-spacing:1px;margin-right:8px;text-transform:uppercase}
.sec-title{font-size:13px;font-weight:600;color:#888;letter-spacing:.3px}
.sec-total{font-family:'IBM Plex Mono',monospace;font-size:14px;color:#e8384f}
.sec-chevron{color:#ccc;font-size:12px;margin-left:8px;transition:transform .2s}
.sec-hdr.open .sec-chevron{transform:rotate(180deg)}
.sec-body{border-top:1px solid #f0ece7;padding:16px 20px;display:none}
.sec-body.open{display:block}

/* param rows */
.param-block{margin-bottom:16px}
.param-block:last-child{margin-bottom:0}
.param-block-title{font-size:10px;font-weight:700;color:#ccc;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #f0ece7}
.param-row{display:grid;grid-template-columns:180px 1fr auto;align-items:center;gap:10px;padding:5px 0}
.param-lbl{font-size:12px;color:#999}
.param-val-display{font-family:'IBM Plex Mono',monospace;font-size:13px;color:#222}
.param-note{font-size:11px;color:#ccc;font-style:italic;text-align:right;max-width:200px}
.param-row.derived .param-lbl{color:#bbb}
.param-row.derived .param-val-display{color:#888}
.param-row.subtotal-row{border-top:1px solid #f0ece7;margin-top:6px;padding-top:10px}
.param-row.subtotal-row .param-lbl{color:#555;font-weight:600}
.param-row.subtotal-row .param-val-display{color:#e8384f;font-size:14px}

/* editable inline input ‚Äî stepper version */
.p-inline{display:flex;align-items:center;gap:6px}
.p-stepper{display:flex;align-items:center;background:#faf9f7;border:1.5px solid #e0dbd4;border-radius:6px;overflow:hidden}
.p-stepper-btn{width:30px;height:34px;background:none;border:none;color:#aaa;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background .1s;flex-shrink:0;user-select:none}
.p-stepper-btn:hover{background:#f0ece7;color:#555}
.p-in{background:transparent;border:none;border-left:1px solid #ede8e2;border-right:1px solid #ede8e2;padding:5px 4px;color:#222;font-family:'IBM Plex Mono',monospace;font-size:13px;width:80px;outline:none;text-align:center;-moz-appearance:textfield}
.p-in::-webkit-outer-spin-button,.p-in::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
.p-in:focus{background:#fff}
.p-unit{font-size:11px;color:#bbb;white-space:nowrap}

/* ‚îÄ‚îÄ CONFIDENCE BADGE ‚îÄ‚îÄ */
.conf-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.3px}
.conf-badge.high{background:#e8f7e0;color:#2d7a1a;border:1px solid #b7dda8}
.conf-badge.medium{background:#fef9e6;color:#9a7200;border:1px solid #f5e088}
.conf-badge.low{background:#fff3e8;color:#c47208;border:1px solid #fdc88a}
.conf-badge.none{background:#f5f2ee;color:#aaa;border:1px solid #e0dbd4}
.conf-badge.proxy{background:#fff3e8;color:#c47208;border:1px solid #fdc88a}
.conf-source{font-size:11px;color:#bbb;margin-left:4px}

/* grand total */
.grand-total{background:#fff;border:1px solid #e0dbd4;border-radius:12px;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;margin-top:4px;box-shadow:0 1px 4px rgba(0,0,0,.05)}
.gt-label{font-size:13px;color:#888}
.gt-val{font-family:'IBM Plex Mono',monospace;font-size:20px;color:#e8384f;font-weight:600}
.gt-permt{font-family:'IBM Plex Mono',monospace;font-size:14px;color:#2d7a1a}

/* ‚îÄ‚îÄ ABOUT PAGE ‚îÄ‚îÄ */
.about-hero{padding:40px 0 32px}
.about-hero h1{font-family:'IBM Plex Sans Condensed',sans-serif;font-size:36px;font-weight:700;color:#222;line-height:1.2;margin-bottom:12px}
.about-hero p{font-size:15px;color:#666;line-height:1.7;max-width:600px}
.about-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:32px 0}
.about-card{background:#fff;border:1px solid #e0dbd4;border-radius:12px;padding:24px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.about-card h3{font-size:15px;font-weight:600;color:#222;margin-bottom:8px}
.about-card p{font-size:13px;color:#888;line-height:1.6}
.about-card .ac-icon{font-size:28px;margin-bottom:12px}
.about-divider{border:none;border-top:1px solid #e8e2da;margin:32px 0}
.about-section h2{font-size:20px;font-weight:700;color:#222;margin-bottom:12px}
.about-section p{font-size:14px;color:#666;line-height:1.7;margin-bottom:12px}

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
footer{background:#fff;border-top:1px solid #e8e2da;margin-top:40px}
.footer-inner{max-width:900px;margin:0 auto;padding:24px 16px;display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap}
.footer-copy{font-size:12px;color:#bbb}
.footer-links{display:flex;gap:16px}
.footer-link{font-size:12px;color:#bbb;cursor:pointer;transition:color .15s}
.footer-link:hover{color:#888}

#results{margin-top:24px;display:none}

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media(max-width:640px){
  /* Prevent iOS zoom */
  input,select,textarea{font-size:16px !important}
  .p-in{font-size:16px !important}

  .wrap{padding:16px 12px 80px}

  /* Nav */
  .nav-inner{height:48px}
  .nav-links .nav-link span{display:none} /* icon only on mobile */
  .nav-link{padding:6px 8px}

  /* Intro */
  .calc-intro{padding:20px 0 16px}
  .calc-intro h1{font-size:22px}

  /* Freight tabs scroll */
  .freight-tabs{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:4px;margin-bottom:16px;gap:6px;scrollbar-width:none}
  .freight-tabs::-webkit-scrollbar{display:none}
  .freight-tab{white-space:nowrap;flex-shrink:0;padding:7px 12px;font-size:12px}

  .form-card{padding:16px;gap:16px}
  .row2{grid-template-columns:1fr}

  /* Fixed dropdown */
  .dd{position:fixed;left:12px !important;right:12px !important;top:auto;max-height:50vh;z-index:1000;box-shadow:0 8px 32px rgba(0,0,0,.15)}

  /* Hero bar */
  .hero-bar{grid-template-columns:repeat(3,1fr);padding:14px 12px;gap:8px}
  .hero-item .val{font-size:18px}
  .hero-item .lbl{font-size:10px}

  /* Section cards */
  .sec-hdr{padding:12px 14px}
  .sec-body{padding:12px 14px}

  /* Param rows ‚Äî stacked */
  .param-row{
    display:flex;flex-direction:column;align-items:flex-start;
    gap:6px;padding:10px 0;border-bottom:1px solid #f5f2ee
  }
  .param-row:last-child{border-bottom:none}
  .param-lbl{font-size:11px;color:#aaa;text-transform:uppercase;letter-spacing:.5px;font-weight:600}
  .param-val-display{font-size:15px;color:#222}
  .param-note{display:block !important;font-size:11px;color:#bbb;font-style:italic;text-align:left;line-height:1.4;max-width:100%}

  /* Stepper full width */
  .p-inline{width:100%}
  .p-stepper{flex:1}
  .p-in{flex:1;width:auto !important;text-align:center}
  .p-stepper-btn{width:40px;height:42px;font-size:18px}
  .p-unit{font-size:12px;flex-shrink:0}

  /* Subtotal rows stay horizontal */
  .param-row.subtotal-row{
    flex-direction:row;justify-content:space-between;align-items:center;
    padding:10px 0;border-bottom:none;border-top:1px solid #f0ece7;margin-top:4px
  }
  .param-row.subtotal-row .param-lbl{font-size:13px;color:#555;font-weight:600;text-transform:none;letter-spacing:0}
  .param-row.subtotal-row .param-val-display{font-size:15px;color:#e8384f}

  .grand-total{padding:14px 16px}
  .gt-val{font-size:17px}
  .calc-btn{padding:16px;font-size:14px;border-radius:10px}
  .route-badge{gap:6px}
  .rbadge{font-size:10px;padding:3px 8px}

  /* About */
  .about-grid{grid-template-columns:1fr}
  .about-hero h1{font-size:26px}

  /* Footer */
  .footer-inner{flex-direction:column;align-items:flex-start;gap:12px}
}

</style>
</head>
<body>
<!-- Loading banner -->
<div id="loading-banner" style="max-width:900px;margin:40px auto;padding:20px 16px;font-family:'IBM Plex Mono',monospace;font-size:13px;color:#e8384f;text-align:center;letter-spacing:1px">
  LOADING DATA‚Ä¶
</div>

<!-- Main app -->
<div id="app-content" style="display:none">

<!-- STICKY NAV -->
<nav>
  <div class="nav-inner">
    <a class="nav-logo" onclick="showPage('calculator')">DryFreight <span class="beta-badge" style="margin-left:8px">Beta</span></a>
    <div class="nav-links">
      <button class="nav-link active" id="nav-calculator" onclick="showPage('calculator')"><span>üßÆ </span>Calculator</button>
      <button class="nav-link" id="nav-about" onclick="showPage('about')"><span>‚ÑπÔ∏è </span>About</button>
    </div>
  </div>
</nav>

<div class="wrap">

<!-- ‚ïê‚ïê CALCULATOR PAGE ‚ïê‚ïê -->
<div class="page-section active" id="page-calculator">

  <div class="calc-intro">
    <h1>Voyage Cost Calculator</h1>
    <p>Live TC rates ¬∑ Real-time bunker prices ¬∑ Instant freight estimation</p>
  </div>

  <!-- FREIGHT TYPE SELECTOR -->
  <div class="freight-tabs">
    <button class="freight-tab active" onclick="selectFreight('drybulk',event)">
      <span class="ft-icon">‚öì</span> Dry Bulk
    </button>
    <button class="freight-tab" onclick="selectFreight('tanker',event)">
      <span class="ft-icon">üõ¢Ô∏è</span> Tankers
    </button>
    <button class="freight-tab" onclick="selectFreight('container',event)">
      <span class="ft-icon">üì¶</span> Containers
    </button>
    <button class="freight-tab" onclick="selectFreight('gas',event)">
      <span class="ft-icon">üí®</span> Gas Carriers
    </button>
    <button class="freight-tab" onclick="selectFreight('breakbulk',event)">
      <span class="ft-icon">üèóÔ∏è</span> Break Bulk
    </button>
  </div>

  <!-- Under development message -->
  <div class="freight-dev-msg" id="freight-dev-msg">
    <div class="dev-icon">üöß</div>
    <h3 id="freight-dev-title">Coming Soon</h3>
    <p id="freight-dev-text">We're building this out. Check back soon.</p>
  </div>

  <!-- DRY BULK CALCULATOR -->
  <div id="drybulk-content">
  <div class="form-card">
    <div class="row2">
      <div class="field">
        <label>Load Port</label>
        <div class="port-wrap">
          <input class="port-in" id="loadSearch" placeholder="Search port‚Ä¶" autocomplete="off"
            oninput="filterPorts('load',this.value)" onfocus="openDD('load')" onblur="closeDD('load')">
          <div class="dd" id="loadDD"></div>
        </div>
        <div class="port-meta" id="loadMeta"></div>
      </div>
      <div class="field">
        <label>Discharge Port</label>
        <div class="port-wrap">
          <input class="port-in" id="dischSearch" placeholder="Search port‚Ä¶" autocomplete="off"
            oninput="filterPorts('disch',this.value)" onfocus="openDD('disch')" onblur="closeDD('disch')">
          <div class="dd" id="dischDD"></div>
        </div>
        <div class="port-meta" id="dischMeta"></div>
      </div>
    </div>

    <div class="row2">
      <div class="field">
        <label>Cargo Quantity</label>
        <div class="num-wrap">
          <input class="num-in" id="cargoMt" type="number" value="50000" min="5000" max="200000" step="1000" oninput="onCargoChange()">
          <span class="num-unit">MT</span>
        </div>
      </div>
      <div class="field">
        <label>Commodity</label>
        <select class="comm-select" id="commodity" onchange="onCargoChange()">
          <option value="default">Default / Unknown</option>
        </select>
      </div>
    </div>

    <div class="row2">
      <div class="field" style="grid-column:1/-1">
        <label>Vessel (auto-selected)</label>
        <div class="vessel-auto">
          <div>
            <div class="va-name" id="vaName">Ultramax</div>
            <div class="va-detail" id="vaDetail">~61,000 DWT ¬∑ 55k‚Äì65k MT</div>
          </div>
          <div class="va-badge">AUTO</div>
        </div>
      </div>
    </div>

    <button class="calc-btn" id="calcBtn" onclick="doCalc()" disabled>CALCULATE FREIGHT</button>

    <!-- Route options ‚Äî shown once both ports are selected -->
    <div class="route-opts-wrap" id="routeOptsWrap">
      <div class="route-opts-label">Select Route</div>
      <div class="route-opts" id="routeOptsList"></div>
    </div>

    <button class="calc-btn" id="calcBtn2" onclick="doCalc()" disabled style="display:none">CALCULATE FREIGHT</button>
  </div>

  <!-- RESULTS -->
  <div id="results">
    <div class="warn" id="warnBox" style="display:none"></div>

    <!-- Hero -->
    <div class="hero-bar">
      <div class="hero-item">
        <div class="val" id="o-permt">‚Äî</div>
        <div class="lbl">$/MT</div>
      </div>
      <div class="hero-item">
        <div class="val" id="o-total">‚Äî</div>
        <div class="lbl">Total Voyage Cost</div>
      </div>
      <div class="hero-item">
        <div class="val" id="o-days">‚Äî</div>
        <div class="lbl" id="o-dayslbl">Total Days</div>
      </div>
    </div>

    <!-- Route info -->
    <div class="route-badge" id="routeBadges"></div>

    <!-- Section 1: TC Hire -->
    <div class="sec-card" id="sec1">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">01</span><span class="sec-title">TC Hire</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-hire">‚Äî</span>
          <span class="sec-chevron">‚ñº</span>
        </div>
      </div>
      <div class="sec-body open">

        <!-- Distance -->
        <div class="param-block">
          <div class="param-block-title">Distance &amp; Route</div>
          <div class="param-row derived">
            <span class="param-lbl">Distance</span>
            <span class="param-val-display" id="o-nm">‚Äî</span>
            <span class="param-note">Haversine + routing waypoints</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">Route</span>
            <span class="param-val-display" id="o-routedetail">‚Äî</span>
            <span class="param-note"></span>
          </div>
        </div>

        <!-- TC Rate -->
        <div class="param-block">
          <div class="param-block-title">TC Rate</div>
          <div class="param-row">
            <span class="param-lbl">Daily hire rate</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-tcrate',-1)">‚àí</button>
                <input id="p-tcrate" class="p-in" type="number" step="500" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-tcrate',1)">+</button>
              </div>
              <span class="p-unit">$/day</span>
            </div>
            <span class="param-note" id="o-tcnote">‚Äî</span>
          </div>
        </div>

        <!-- Sea days -->
        <div class="param-block">
          <div class="param-block-title">Days at Sea</div>
          <div class="param-row">
            <span class="param-lbl">Laden speed</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ladenspd',-1)">‚àí</button>
                <input id="p-ladenspd" class="p-in" type="number" step="0.5" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ladenspd',1)">+</button>
              </div>
              <span class="p-unit">knots</span>
            </div>
            <span class="param-note">Vessel design speed</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Weather factor</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-wx',-1)">‚àí</button>
                <input id="p-wx" class="p-in" type="number" step="0.01" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-wx',1)">+</button>
              </div>
            </div>
            <span class="param-note">1.05 = 5% extra for weather/routing</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">‚Üí Laden days</span>
            <span class="param-val-display" id="o-ladendays">‚Äî</span>
            <span class="param-note">nm √ó weather √∑ (speed √ó 24)</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Ballast speed</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ballspd',-1)">‚àí</button>
                <input id="p-ballspd" class="p-in" type="number" step="0.5" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ballspd',1)">+</button>
              </div>
              <span class="p-unit">knots</span>
            </div>
            <span class="param-note"></span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Ballast factor</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ball',-1)">‚àí</button>
                <input id="p-ball" class="p-in" type="number" step="0.05" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ball',1)">+</button>
              </div>
            </div>
            <span class="param-note" id="o-ballnote">Ballast leg as fraction of laden distance</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">‚Üí Ballast days</span>
            <span class="param-val-display" id="o-balldays">‚Äî</span>
            <span class="param-note">nm √ó ballast factor √∑ (speed √ó 24)</span>
          </div>
        </div>

        <!-- Port days -->
        <div class="param-block">
          <div class="param-block-title">Days in Port</div>
          <div class="param-row">
            <span class="param-lbl">Load port rate</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-lrate',-1)">‚àí</button>
                <input id="p-lrate" class="p-in" type="number" step="500" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-lrate',1)">+</button>
              </div>
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note" id="o-lratenote" style="max-width:160px;text-align:right">‚Äî</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Disch. port rate</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-drate',-1)">‚àí</button>
                <input id="p-drate" class="p-in" type="number" step="500" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-drate',1)">+</button>
              </div>
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note" id="o-dratenote" style="max-width:160px;text-align:right">‚Äî</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">‚Üí Port days</span>
            <span class="param-val-display" id="o-portdays">‚Äî</span>
            <span class="param-note">cargo √∑ rate + 0.75d turn each port</span>
          </div>
          <div class="param-row subtotal-row">
            <span class="param-lbl">Total days</span>
            <span class="param-val-display" id="o-totaldays">‚Äî</span>
            <span class="param-note">laden + ballast + port</span>
          </div>
        </div>

      </div><!-- /sec-body -->
    </div><!-- /sec1 -->

    <!-- Section 2: Bunkers -->
    <div class="sec-card" id="sec2">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">02</span><span class="sec-title">Bunkers</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-bunk">‚Äî</span>
          <span class="sec-chevron">‚ñº</span>
        </div>
      </div>
      <div class="sec-body open">

        <div class="param-block">
          <div class="param-block-title">Fuel Prices</div>
          <div class="param-row">
            <span class="param-lbl">VLSFO price</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-vlsfopx',-1)">‚àí</button>
                <input id="p-vlsfopx" class="p-in" type="number" step="5" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-vlsfopx',1)">+</button>
              </div>
              <span class="p-unit">$/MT</span>
            </div>
            <span class="param-note" id="o-vlsfonote">Ship &amp; Bunker</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">MGO price</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-mgopx',-1)">‚àí</button>
                <input id="p-mgopx" class="p-in" type="number" step="5" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-mgopx',1)">+</button>
              </div>
              <span class="p-unit">$/MT</span>
            </div>
            <span class="param-note" id="o-mgonote">Ship &amp; Bunker</span>
          </div>
        </div>

        <div class="param-block">
          <div class="param-block-title">Consumption Rates</div>
          <div class="param-row">
            <span class="param-lbl">Laden consumption</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ladencons',-1)">‚àí</button>
                <input id="p-ladencons" class="p-in" type="number" step="1" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ladencons',1)">+</button>
              </div>
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note">Main engine laden</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Ballast consumption</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ballcons',-1)">‚àí</button>
                <input id="p-ballcons" class="p-in" type="number" step="1" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-ballcons',1)">+</button>
              </div>
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note">Main engine ballast</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Port consumption</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-portcons',-1)">‚àí</button>
                <input id="p-portcons" class="p-in" type="number" step="0.5" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-portcons',1)">+</button>
              </div>
              <span class="p-unit">MT/day</span>
            </div>
            <span class="param-note">Aux. engines in port</span>
          </div>
        </div>

        <div class="param-block">
          <div class="param-block-title">Breakdown</div>
          <div class="param-row derived">
            <span class="param-lbl">VLSFO (sea)</span>
            <span class="param-val-display" id="o-vlsfomt">‚Äî</span>
            <span class="param-note" id="o-vlsfocost">‚Äî</span>
          </div>
          <div class="param-row derived" id="row-mgo" style="display:none">
            <span class="param-lbl">MGO (ECA zones)</span>
            <span class="param-val-display" id="o-ecomt">‚Äî</span>
            <span class="param-note" id="o-ecocost">‚Äî</span>
          </div>
          <div class="param-row derived">
            <span class="param-lbl">MDO (port)</span>
            <span class="param-val-display" id="o-portmdoamt">‚Äî</span>
            <span class="param-note" id="o-portmdocost">‚Äî</span>
          </div>
          <div class="param-row subtotal-row">
            <span class="param-lbl">Total bunkers</span>
            <span class="param-val-display" id="o-bunk2">‚Äî</span>
            <span class="param-note"></span>
          </div>
        </div>

      </div>
    </div>

    <!-- Section 3: Port DAs -->
    <div class="sec-card" id="sec3">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">03</span><span class="sec-title">Port Disbursements (DAs)</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-das">‚Äî</span>
          <span class="sec-chevron">‚ñº</span>
        </div>
      </div>
      <div class="sec-body open">
        <div class="param-block">
          <div class="param-block-title">Estimated Disbursement Accounts</div>
          <div class="param-row">
            <span class="param-lbl">Load port DA</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-daload',-1)">‚àí</button>
                <input id="p-daload" class="p-in" type="number" step="1000" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-daload',1)">+</button>
              </div>
              <span class="p-unit">USD</span>
            </div>
            <span class="param-note" id="o-daloadnote">‚Äî</span>
          </div>
          <div class="param-row">
            <span class="param-lbl">Discharge port DA</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-dadisch',-1)">‚àí</button>
                <input id="p-dadisch" class="p-in" type="number" step="1000" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-dadisch',1)">+</button>
              </div>
              <span class="p-unit">USD</span>
            </div>
            <span class="param-note" id="o-dadischnote">‚Äî</span>
          </div>
          <div class="param-row subtotal-row">
            <span class="param-lbl">Total DAs</span>
            <span class="param-val-display" id="o-das2">‚Äî</span>
            <span class="param-note">Agency, port dues, pilotage, towage</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 4: Canals (conditional) -->
    <div class="sec-card" id="sec4" style="display:none">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">04</span><span class="sec-title">Canal Tolls</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-canals">‚Äî</span>
          <span class="sec-chevron">‚ñº</span>
        </div>
      </div>
      <div class="sec-body open" id="sec4body">
        <!-- filled dynamically -->
      </div>
    </div>

    <!-- Section 5: War Risk (conditional) -->
    <div class="sec-card" id="sec5" style="display:none">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num">05</span><span class="sec-title">War Risk Insurance</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-war">‚Äî</span>
          <span class="sec-chevron">‚ñº</span>
        </div>
      </div>
      <div class="sec-body open" id="sec5body">
        <!-- filled dynamically -->
      </div>
    </div>

    <!-- Section 6: Commission -->
    <div class="sec-card">
      <div class="sec-hdr open" onclick="toggleSec(this)">
        <div><span class="sec-num" id="sec6num">06</span><span class="sec-title">Address Commission</span></div>
        <div style="display:flex;align-items:center">
          <span class="sec-total" id="o-comm">‚Äî</span>
          <span class="sec-chevron">‚ñº</span>
        </div>
      </div>
      <div class="sec-body open">
        <div class="param-block">
          <div class="param-block-title">Brokerage &amp; Address Commission</div>
          <div class="param-row">
            <span class="param-lbl">Commission rate</span>
            <div class="p-inline">
              <div class="p-stepper">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-commpct',-1)">‚àí</button>
                <input id="p-commpct" class="p-in" type="number" step="0.25" min="0" max="10" oninput="onParamChange()">
                <button class="p-stepper-btn" type="button" onclick="stepInput('p-commpct',1)">+</button>
              </div>
              <span class="p-unit">%</span>
            </div>
            <span class="param-note">Applied to total voyage cost</span>
          </div>
          <div class="param-row subtotal-row">
            <span class="param-lbl">Total commission</span>
            <span class="param-val-display" id="o-comm2">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Grand Total -->
    <div class="grand-total">
      <div>
        <div class="gt-label">Total Voyage Cost</div>
        <div style="font-size:11px;color:#444;margin-top:2px" id="o-gtcargo">‚Äî</div>
      </div>
      <div style="text-align:right">
        <div class="gt-val" id="o-grandtotal">‚Äî</div>
        <div class="gt-permt" id="o-grandpermt">‚Äî</div>
      </div>
    </div>

  </div><!-- /results -->
</div><!-- /drybulk-content -->
</div><!-- /page-calculator -->

<!-- ‚ïê‚ïê ABOUT PAGE ‚ïê‚ïê -->
<div class="page-section" id="page-about">
  <div class="about-hero">
    <h1>Transparent freight costs,<br>for everyone.</h1>
    <p>DryFreight is a free voyage cost calculator built for shipowners, charterers, traders, and anyone who needs a fast, honest freight estimate without paying for a Bloomberg terminal.</p>
  </div>

  <div class="about-grid">
    <div class="about-card">
      <div class="ac-icon">üì°</div>
      <h3>Live Market Data</h3>
      <p>TC rates scraped daily from HandyBulk. Bunker prices updated from Ship & Bunker across 4 major hubs. No stale hardcoded numbers.</p>
    </div>
    <div class="about-card">
      <div class="ac-icon">üî¢</div>
      <h3>Full Cost Breakdown</h3>
      <p>Every assumption is visible and editable. TC hire, bunkers, port DAs, canal tolls, war risk, commission ‚Äî nothing hidden.</p>
    </div>
    <div class="about-card">
      <div class="ac-icon">üåç</div>
      <h3>235 Ports</h3>
      <p>Route detection with realistic waypoints ‚Äî Suez, Malacca, Gibraltar, Cape, Panama. Calibrated distances against real-world data.</p>
    </div>
    <div class="about-card">
      <div class="ac-icon">üîí</div>
      <h3>Always Free</h3>
      <p>No subscription, no login, no paywalls. Built in public. More vessel types and fixture sharing coming soon.</p>
    </div>
  </div>

  <hr class="about-divider">

  <div class="about-section">
    <h2>How it works</h2>
    <p>Enter a load port, discharge port, cargo quantity and commodity. The calculator selects the right vessel size, finds the best available live TC rate for that corridor, looks up current bunker prices at the nearest hub, and computes the full voyage cost in seconds.</p>
    <p>Every parameter can be overridden. If you know the actual TC rate from your broker, type it in. The system shows you exactly where each number came from and how confident it is.</p>
  </div>

  <hr class="about-divider">

  <div class="about-section">
    <h2>What's coming</h2>
    <p><strong>Fixture sharing</strong> ‚Äî submit TC fixtures directly from the market and help build a community rate index. Tanker, container, and gas carrier calculators. A blog covering freight markets, methodology, and data. An API for developers.</p>
    <p>Built by a small team that ships fast. If you have feedback, a fixture to contribute, or want to talk ‚Äî reach out.</p>
  </div>
</div><!-- /page-about -->

</div><!-- /wrap -->

<!-- FOOTER -->
<footer>
  <div class="footer-inner">
    <span class="footer-copy">¬© 2026 DryFreight ¬∑ Beta ¬∑ Data for reference only</span>
    <div class="footer-links">
      <span class="footer-link" onclick="showPage('calculator')">Calculator</span>
      <span class="footer-link" onclick="showPage('about')">About</span>
    </div>
  </div>
</footer>

</div><!-- /app-content -->

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL DATA ‚Äî populated by loadData() on startup
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let PORTS        = [];
let VESSEL_SPECS = {};
let VESSEL_RANGES= [];
let LANES         = [];   // trade lane structure from fixtures.json (no rates)

let DA           = {};
let PORT_RATE    = {};
let ECA          = new Set();
let WAR          = {};
let TOLLS        = {};
let DEFAULT_BUNKER_PRICES = {vlsfo: 615, mgo: 870};

// Live rates from API ‚Äî populated after loadData()
// Each entry: {vesselType, originRegion, destinationRegion, rate, confidence, tier, daysOld, scrapedDate, rawLine}
let LIVE_RATES = [];

// Bunker prices by hub ‚Äî populated after loadData()
// { Singapore: {vlsfo, mgo, scrapedDate, daysOld}, Rotterdam: {...}, ... }
let BUNKER_PRICES = {};

// Commodity data ‚Äî populated by loadData()
let COMMODITIES       = {};   // commodity definitions
let REGIONAL_DEFAULTS = {};   // commodity √ó region rates
let PORT_RATES_COMM   = {};   // port-specific overrides per commodity
let BALLAST_FACTORS   = {};   // ballast factor by discharge region

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VESSEL HELPERS
// These use the globals populated by loadData()
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMMODITY RATE LOOKUP
// Returns load and discharge rates for a given
// commodity at a specific port, using:
//   1. Port-specific override if available
//   2. Regional default for that commodity
//   3. Commodity base rate
//   4. Legacy portRate fallback
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getPortRates(port, commodity){
  const comm = commodity || 'default';
  const portName = port.name || '';
  const region   = port.region || '';

  // 1. Port-specific override
  const portOverride = PORT_RATES_COMM[portName];
  if(portOverride){
    const commOverride = portOverride[comm] || portOverride['default'];
    const defOverride  = portOverride['default'];
    // Merge: comm-specific fields override default fields
    const merged = {...(defOverride||{}), ...(commOverride||{})};
    if(merged.load || merged.disch){
      // Fall back any missing side to regional default
      const reg = (REGIONAL_DEFAULTS[region]||{})[comm]
               || (REGIONAL_DEFAULTS[region]||{})['default']
               || {};
      return {
        load:  merged.load  || reg.load  || (COMMODITIES[comm]||{}).loadBase  || 8000,
        disch: merged.disch || reg.disch || (COMMODITIES[comm]||{}).dischBase || 8000,
      };
    }
  }

  // 2. Regional default for this commodity
  const regComm = (REGIONAL_DEFAULTS[region]||{})[comm];
  if(regComm) return { load: regComm.load, disch: regComm.disch };

  // 3. Regional default for 'default' commodity
  const regDef = (REGIONAL_DEFAULTS[region]||{})['default'];
  if(regDef) return { load: regDef.load, disch: regDef.disch };

  // 4. Commodity base rate
  const base = COMMODITIES[comm] || COMMODITIES['default'] || {};
  return { load: base.loadBase||8000, disch: base.dischBase||8000 };
}

function getBallastFactor(dischRegion){
  return BALLAST_FACTORS[dischRegion] || 0.65;
}

function populateCommoditySelect(){
  const sel = document.getElementById('commodity');
  if(!sel || !COMMODITIES) return;
  sel.innerHTML = '';
  for(const [key, val] of Object.entries(COMMODITIES)){
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = val.label;
    sel.appendChild(opt);
  }
}


function vesselForCargo(mt){
  for(const v of VESSEL_RANGES) if(mt>=v.min && mt<=v.max) return v;
  return VESSEL_RANGES[VESSEL_RANGES.length-1];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TC RATE MATCHING ‚Äî CORRIDOR-BASED SYSTEM
//
// Shipping operates in trade corridors, not isolated
// regions. A vessel fixing N.Europe ‚Üí ECSA competes
// in the same market as W.Med ‚Üí ECSA. But it tells
// us nothing about W.Med ‚Üí N.Europe (opposite leg).
//
// Scoring model (max 100 before freshness):
//   Origin corridor match:
//     exact region   = 40
//     same corridor  = 30   (e.g. W.MED & N.EUROPE both ATL_EUR)
//     adj corridor   = 12   (e.g. ATL_EUR & E_MED are adjacent)
//     else           =  0
//   Destination corridor match: same scale (40/30/12/0)
//   Vessel match:
//     exact          = 20
//     1 size step    = 10   (e.g. Handy ‚Üî Supramax)
//     2 size steps   =  3   (e.g. Handy ‚Üî Ultramax)
//     3+ steps       =  0   (e.g. Handy ‚Üî Panamax)
//
//   Direction penalty: if fixture is the REVERSE of
//   our voyage (origin ‚âà our dest AND dest ‚âà our
//   origin), multiply total by 0.15 ‚Äî backhaul rates
//   are structurally different and should almost never
//   be used.
//
//   Freshness factor: tier1=1.0, tier2=0.9, tier3=0.75
//   Multiply raw score to get effective score.
//
//   Minimum threshold: effective score < 45 ‚Üí reject,
//   fall back to hardcoded fixture.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Region ‚Üí corridor mapping
// ATL_AMER is deliberately split into two distinct markets:
//   N_ATL_AMER = US Gulf, East Coast, Caribbean, Mexico
//   S_ATL_AMER = East South America (ECSA), North SA
// These trade at structurally different rate levels and must
// not be treated as equivalent destinations.
const CORRIDOR = {
  'N.EUROPE':      'ATL_EUR',
  'BALTIC':        'ATL_EUR',
  'W.MED':         'ATL_EUR',
  'E.MED':         'E_MED',
  'BLACK SEA':     'E_MED',
  'W.AFRICA':      'W_AFR',
  'S.AFRICA':      'S_AFR',
  'E.AFRICA':      'E_AFR',
  'RED SEA':       'RED_GULF',
  'MIDDLE EAST':   'RED_GULF',
  'W.INDIA':       'INDIAN',
  'E.INDIA':       'INDIAN',
  'S.INDIA':       'INDIAN',
  'SE.ASIA':       'ASIA',
  'CHINA':         'ASIA',
  'N.ASIA':        'ASIA',
  'AUSTRALIA':     'ASIA',
  'US GULF':       'N_ATL_AMER',
  'US EAST COAST': 'N_ATL_AMER',
  'CARIBBEAN':     'N_ATL_AMER',
  'MEXICO':        'N_ATL_AMER',
  'E.N.AMERICA':   'N_ATL_AMER',
  'E.S.AMERICA':   'S_ATL_AMER',
  'N.S.AMERICA':   'S_ATL_AMER',
  'W.S.AMERICA':   'PAC_AMER',
};

// Adjacent corridor pairs (bidirectional)
const CORRIDOR_ADJ = [
  ['ATL_EUR',    'E_MED'],       // Med ‚Üî North Sea/Atlantic
  ['ATL_EUR',    'W_AFR'],       // Europe ‚Üî West Africa
  ['ATL_EUR',    'N_ATL_AMER'],  // Transatlantic (Europe ‚Üî US/Caribbean)
  ['ATL_EUR',    'S_ATL_AMER'],  // Europe ‚Üî South America
  ['E_MED',      'RED_GULF'],    // Suez connection
  ['E_MED',      'W_AFR'],       // Med ‚Üî West Africa
  ['W_AFR',      'N_ATL_AMER'],  // West Africa ‚Üî North Americas
  ['W_AFR',      'S_ATL_AMER'],  // West Africa ‚Üî South Americas
  ['W_AFR',      'S_AFR'],       // West ‚Üî South Africa
  ['S_AFR',      'E_AFR'],       // South ‚Üî East Africa
  ['S_AFR',      'INDIAN'],      // South Africa ‚Üî Indian Ocean
  ['RED_GULF',   'INDIAN'],      // Gulf ‚Üî India
  ['RED_GULF',   'E_AFR'],       // Gulf ‚Üî East Africa
  ['INDIAN',     'ASIA'],        // India ‚Üî Asia
  ['N_ATL_AMER', 'S_ATL_AMER'],  // North ‚Üî South America
  ['ASIA',       'PAC_AMER'],    // Transpacific
  ['PAC_AMER',   'S_ATL_AMER'],  // Pacific Americas ‚Üî South Atlantic
  ['N_ATL_AMER', 'PAC_AMER'],    // Panama corridor
];

function corridorOf(region){
  return CORRIDOR[region] || region;
}

function corridorsAdjacent(cA, cB){
  for(const [x,y] of CORRIDOR_ADJ){
    if((x===cA&&y===cB)||(x===cB&&y===cA)) return true;
  }
  return false;
}

// Score how well a fixture region matches our target region
function corridorScore(fixtureRegion, targetRegion){
  if(fixtureRegion === targetRegion)                return 40; // exact region
  const fC = corridorOf(fixtureRegion);
  const tC = corridorOf(targetRegion);
  if(fC === tC)                                     return 30; // same corridor
  if(corridorsAdjacent(fC, tC))                     return 12; // adjacent corridor
  return 0;
}

// Vessel size order for step-distance calculation
const VESSEL_ORDER = ['HANDY','SUPRAMAX','ULTRAMAX','PANAMAX','CAPESIZE'];

function vesselScore(fixtureVt, targetVt){
  const a = VESSEL_ORDER.indexOf(fixtureVt);
  const b = VESSEL_ORDER.indexOf(targetVt);
  if(a < 0 || b < 0) return (fixtureVt === targetVt) ? 20 : 0;
  const steps = Math.abs(a - b);
  if(steps === 0) return 20;
  if(steps === 1) return 10;
  if(steps === 2) return  3;
  return 0;
}

// Is this fixture approximately the reverse of our voyage?
// Only flag as reverse if corridors match exactly AND
// the origin and destination corridors are different
// (intra-corridor voyages can't have a meaningful "reverse").
function isReverse(fOrig, fDest, oR, dR){
  const foC = corridorOf(fOrig), fdC = corridorOf(fDest);
  const oC  = corridorOf(oR),    dC  = corridorOf(dR);
  if(oC === dC) return false; // same corridor voyage ‚Äî no reverse concept
  return (foC === dC) && (fdC === oC);
}

// Freshness multiplier by tier
function freshnessFactor(tier){
  if(tier === 1) return 1.00;
  if(tier === 2) return 0.90;
  if(tier === 3) return 0.75;
  return 0.60;
}

// Score a single fixture/rate candidate against our voyage
function scoreCandidate(candOrig, candDest, candVt, candTier, oR, dR, vt){
  const oScore = corridorScore(candOrig, oR);
  const dScore = corridorScore(candDest, dR);
  const vScore = vesselScore(candVt, vt);

  // Strict qualification: BOTH sides must independently score >= 20.
  // This means both origin and destination must be in the same corridor
  // as the target (or better ‚Äî exact region match scores 40, same corridor 30).
  // Adjacency alone (12pts) never qualifies a side on its own.
  // A fixture with the wrong destination corridor is useless regardless
  // of how well the origin matches.
  if(oScore < 20 || dScore < 20) return 0;

  let raw = oScore + dScore + vScore;

  // Heavy penalty for reverse direction
  if(isReverse(candOrig, candDest, oR, dR)) raw *= 0.15;

  return raw * freshnessFactor(candTier);
}

// ‚îÄ‚îÄ Match against LIVE_RATES (scraped from HandyBulk) ‚îÄ‚îÄ
function matchLive(oR, dR, vt){
  let best = null, bestScore = 0;

  for(const r of LIVE_RATES){
    const s = scoreCandidate(
      r.originRegion, r.destinationRegion, r.vesselType,
      r.tier, oR, dR, vt
    );
    if(s > bestScore){ bestScore = s; best = r; }
  }

  // Threshold: effective score must be at least 45 to use
  if(!best || bestScore < 45) return null;

  const matchQuality = Math.min(bestScore / 100, 1.0);
  let conf = Math.round(best.confidence * matchQuality);
  conf = Math.max(conf, 20);

  const oExact = best.originRegion      === oR ? '‚úì' : '~';
  const dExact = best.destinationRegion === dR ? '‚úì' : '~';
  const vExact = best.vesselType        === vt ? '‚úì' : '~';
  const age    = best.daysOld === 0 ? 'today' : best.daysOld + 'd old';

  return {
    rate:        best.rate,
    confidence:  conf,
    tier:        best.tier,
    daysOld:     best.daysOld,
    scrapedDate: best.scrapedDate,
    rawLine:     best.rawLine,
    source:      'live',
    matchNote:   `${best.vesselType}${vExact} ${best.originRegion}${oExact}‚Üí${best.destinationRegion}${dExact} (${age}, score:${Math.round(bestScore)})`,
  };
}

// ‚îÄ‚îÄ Proxy match when no direct live rate found ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// When the DB has no qualifying rate for the requested
// corridor pair, try to find the BEST available live rate
// ignoring the oScore/dScore minimums ‚Äî strictly for
// information, shown with very low confidence so the user
// knows to verify it. Better than a blank field with no signal.
function matchProxy(oR, dR, vt){
  let best = null, bestScore = 0;

  // Scoring without the qualification gate ‚Äî pure corridor distance
  function proxyScore(r){
    const VESSEL_ORDER = ['HANDY','SUPRAMAX','ULTRAMAX','PANAMAX','CAPESIZE'];
    function corScore(fr, tr){
      if(fr===tr) return 40;
      if(corridorOf(fr)===corridorOf(tr)) return 30;
      if(corridorsAdjacent(corridorOf(fr),corridorOf(tr))) return 12;
      return 0;
    }
    const os = corScore(r.originRegion, oR);
    const ds = corScore(r.destinationRegion, dR);
    if(os===0 && ds===0) return 0;  // completely irrelevant, skip
    const a = VESSEL_ORDER.indexOf(r.vesselType);
    const b = VESSEL_ORDER.indexOf(vt);
    const vs = (a<0||b<0) ? 0 : [20,10,3,0,0][Math.min(Math.abs(a-b),4)];
    let raw = os + ds + vs;
    if(isReverse(r.originRegion, r.destinationRegion, oR, dR)) raw *= 0.15;
    return raw * freshnessFactor(r.tier);
  }

  for(const r of LIVE_RATES){
    const s = proxyScore(r);
    if(s > bestScore){ bestScore = s; best = r; }
  }

  if(!best || bestScore < 20) return null;  // nothing useful at all

  // Cap proxy confidence at 25/100 ‚Äî it's a rough signal only
  const age = best.daysOld === 0 ? 'today' : best.daysOld + 'd old';
  return {
    rate:        best.rate,
    confidence:  Math.min(25, Math.round(bestScore * 0.25)),
    tier:        best.tier,
    daysOld:     best.daysOld,
    scrapedDate: best.scrapedDate,
    rawLine:     best.rawLine,
    source:      'proxy',
    matchNote:   `${best.vesselType} ${best.originRegion}‚Üí${best.destinationRegion} (${age}, proxy score:${Math.round(bestScore)})`,
  };
}

// ‚îÄ‚îÄ Find best matching trade lane (no rates ‚Äî structure only) ‚îÄ‚îÄ
// LANES is the list of known trade corridors from fixtures.json.
// We use it only to identify the closest structural match and
// produce a descriptive note ‚Äî never to supply a rate value.
function bestLaneMatch(oR, dR, vt){
  let best = null, bestScore = 0;
  for(const lane of LANES){
    const s = scoreCandidate(lane.oR, lane.dR, lane.vt, 1, oR, dR, vt);
    if(s > bestScore){ bestScore = s; best = lane; }
  }
  return best ? { lane: best, score: bestScore } : null;
}

// ‚îÄ‚îÄ Main TC rate lookup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function matchTC(oR, dR, vt){
  const live = matchLive(oR, dR, vt);
  if(live) return { ...live, noData: false };

  // No direct match ‚Äî try proxy (any live rate with corridor relevance)
  const proxy = matchProxy(oR, dR, vt);
  if(proxy) return { ...proxy, noData: false };

  // Check if we have the reverse direction ‚Äî useful context for the user
  // even though we can't use the rate directly
  let reverseNote = null;
  for(const r of LIVE_RATES){
    const os = corridorScore(r.originRegion, dR);  // fixture origin vs OUR destination
    const ds = corridorScore(r.destinationRegion, oR); // fixture dest vs OUR origin
    if(os >= 30 && ds >= 30 && r.vesselType === vt){
      const age = r.daysOld === 0 ? 'today' : r.daysOld + 'd ago';
      reverseNote = `Reverse rate (${r.originRegion}‚Üí${r.destinationRegion}) is $${r.rate.toLocaleString()}/day (${age}) ‚Äî backhaul typically 35‚Äì50% of this`;
      break;
    }
  }

  // Genuinely no usable data ‚Äî user must enter manually
  const lm = bestLaneMatch(oR, dR, vt);
  const laneNote = lm
    ? `Closest lane: ${lm.lane.vt} ${lm.lane.oR}‚Üí${lm.lane.dR}`
    : 'No matching lane found';

  return {
    rate:        null,
    confidence:  0,
    tier:        null,
    daysOld:     null,
    scrapedDate: null,
    source:      'nodata',
    matchNote:   reverseNote || laneNote,
    reverseNote,
    noData:      true,
  };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA LOADER
// Fetches all JSON files in parallel, then inits UI.
// Falls back gracefully if a file fails.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadData(){
  try {
    // Load static JSON files and live API rates in parallel.
    // Live rates failure is non-fatal ‚Äî we fall back to fixtures.
    // Helper: fetch with timeout
    const fetchJSON = (url, timeoutMs=8000) => {
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort(), timeoutMs);
      return fetch(url, {signal: controller.signal})
        .then(r => { clearTimeout(timer); return r.json(); })
        .catch(() => { clearTimeout(timer); return null; });
    };

    const [portsData, vesselsData, fixturesData, regionsData, commoditiesData, liveData] = await Promise.all([
      fetchJSON('./data/ports.json'),
      fetchJSON('./data/vessels.json'),
      fetchJSON('./data/fixtures.json'),
      fetchJSON('./data/regions.json'),
      fetchJSON('./data/commodities.json'),
      fetchJSON('/api/rates', 12000),
    ]);

    // Core data ‚Äî these are required
    if(!portsData || !vesselsData || !fixturesData || !regionsData){
      throw new Error('Failed to load core data files.');
    }

    PORTS         = portsData;
    VESSEL_SPECS  = vesselsData.specs;
    VESSEL_RANGES = vesselsData.ranges;
    LANES         = fixturesData.lanes || [];
    DA            = regionsData.da;
    PORT_RATE     = regionsData.portRate;
    ECA           = new Set(regionsData.ecaRegions);
    WAR           = regionsData.war;
    TOLLS         = regionsData.tolls;
    DEFAULT_BUNKER_PRICES = regionsData.defaultBunkerPrices;

    // Commodity data ‚Äî non-fatal if missing
    if(commoditiesData){
      COMMODITIES       = commoditiesData.commodities       || {};
      REGIONAL_DEFAULTS = commoditiesData.regionalDefaults  || {};
      PORT_RATES_COMM   = commoditiesData.portRates         || {};
      BALLAST_FACTORS   = commoditiesData.ballastFactors    || {};
      populateCommoditySelect();
      console.log('[DryFreight] Commodity data loaded');
    } else {
      console.warn('[DryFreight] commodities.json not found ‚Äî using defaults');
      populateCommoditySelect();
    }

    // Live rates ‚Äî non-fatal if missing
    if(liveData && liveData.success && liveData.rates && liveData.rates.length > 0){
      LIVE_RATES = liveData.rates;
      console.log(`[DryFreight] Live rates loaded: ${LIVE_RATES.length} routes`);
    } else {
      console.warn('[DryFreight] Live rates unavailable.');
    }

    // Bunker prices ‚Äî non-fatal if missing
    if(liveData && liveData.bunker && Object.keys(liveData.bunker).length > 0){
      BUNKER_PRICES = liveData.bunker;
      console.log(`[DryFreight] Bunker prices loaded: ${Object.keys(BUNKER_PRICES).join(', ')}`);
    } else {
      console.log('[DryFreight] Bunker prices unavailable ‚Äî using fallback values');
    }

    // Hide loading banner, show app
    document.getElementById('loading-banner').style.display = 'none';
    document.getElementById('app-content').style.display    = 'block';

    // Init port dropdowns
    renderDD('load',  PORTS.slice(0, 80), '');
    renderDD('disch', PORTS.slice(0, 80), '');

  } catch(err) {
    document.getElementById('loading-banner').textContent =
      '‚ö† Failed to load data: ' + err.message + '. Please refresh.';
    console.error('DryFreight data load error:', err);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROUTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function haversine(la1,lo1,la2,lo2){
  const R=3440.065,r=Math.PI/180;
  const dLa=(la2-la1)*r,dLo=(lo2-lo1)*r;
  const a=Math.sin(dLa/2)**2+Math.cos(la1*r)*Math.cos(la2*r)*Math.sin(dLo/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
const WP={
  suez:     {lat:30.0,  lon:32.5},   // Suez Canal entrance
  aden:     {lat:12.5,  lon:44.5},   // Bab-el-Mandeb / Gulf of Aden
  malacca:  {lat:1.5,   lon:103.8},  // Strait of Malacca
  srilanka: {lat:6.0,   lon:80.5},   // Southern tip of India/Sri Lanka ‚Äî routing around subcontinent
  gib:      {lat:36.0,  lon:-5.4},   // Gibraltar
  istanbul: {lat:41.0,  lon:28.97},  // Bosphorus
  panama:   {lat:9.0,   lon:-79.5},  // Panama Canal
  cape:     {lat:-34.5, lon:20.0},   // Cape of Good Hope
  florida:  {lat:25.0,  lon:-80.0},  // Florida Straits ‚Äî exit for Gulf of Mexico ports
  caribbean:{lat:15.0,  lon:-60.0},  // Lesser Antilles ‚Äî waypoint for Gulf‚ÜíSouth America
};

// ‚îÄ‚îÄ Routing zone for a port ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Splits the world into 6 zones based on which canals
// a vessel would actually use to get there.
function routeZone(p){
  const r=p.region||'', b=p.basin||'';
  if(r==='W.S.AMERICA') return 'PAC_AMER';
  if(r==='MEXICO' && b==='PACIFIC') return 'PAC_AMER';
  if(['SE.ASIA','CHINA','N.ASIA','AUSTRALIA'].includes(r)) return 'ASIA';
  if(['W.INDIA','E.INDIA','S.INDIA','RED SEA','MIDDLE EAST','E.AFRICA'].includes(r)) return 'INDIAN';
  if(r==='S.AFRICA' && b==='INDIAN') return 'INDIAN';
  if(['N.EUROPE','BALTIC','W.MED','E.MED'].includes(r)) return 'EUR_MED';
  if(r==='BLACK SEA') return 'BLACK';
  if(r==='W.AFRICA' || (r==='S.AFRICA' && b==='ATLANTIC')) return 'W_AFRICA';
  if(['US GULF','US EAST COAST','E.N.AMERICA','E.S.AMERICA','N.S.AMERICA','CARIBBEAN','MEXICO'].includes(r)) return 'ATL_AMER';
  return 'EUR_MED';
}

// ‚îÄ‚îÄ Distance via Suez with realistic multi-waypoint paths ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Haversine alone badly underestimates Suez routes from Europe because
// it cuts straight through the Mediterranean landmass.
// Fix: route explicitly through Gibraltar ‚Üí Suez ‚Üí Aden ‚Üí [Malacca]
function distViaSuez(pA,pB,zA,zB){
  const h=haversine;
  const isEurSide=z=>['EUR_MED','BLACK','W_AFRICA'].includes(z);
  const isEastSide=z=>['INDIAN','ASIA'].includes(z);
  const eurZ=isEurSide(zA)?zA:zB, eastZ=isEastSide(zA)?zA:zB;
  const eurP=isEurSide(zA)?pA:pB, eastP=isEastSide(zA)?pA:pB;

  // Origin ‚Üí Suez Canal entrance
  let dToSuez;
  if(eurZ==='BLACK'){
    dToSuez = h(eurP.lat,eurP.lon,WP.istanbul.lat,WP.istanbul.lon)
            + h(WP.istanbul.lat,WP.istanbul.lon,WP.gib.lat,WP.gib.lon)
            + h(WP.gib.lat,WP.gib.lon,WP.suez.lat,WP.suez.lon);
  } else {
    // EUR_MED or W_AFRICA: must traverse Mediterranean via Gibraltar
    dToSuez = h(eurP.lat,eurP.lon,WP.gib.lat,WP.gib.lon)
            + h(WP.gib.lat,WP.gib.lon,WP.suez.lat,WP.suez.lon);
  }

  // Suez Canal exit ‚Üí destination
  let dFromSuez;
  const rEast=eastP.region||'';
  if(rEast==='RED SEA'){
    // Red Sea is a narrow winding corridor ‚Äî actual sailing ‚âà 2√ó haversine
    dFromSuez = h(WP.suez.lat,WP.suez.lon,eastP.lat,eastP.lon)*2.0;
  } else if(eastZ==='INDIAN'){
    // India / Middle East / E.Africa: Aden is the natural waypoint
    dFromSuez = h(WP.suez.lat,WP.suez.lon,WP.aden.lat,WP.aden.lon)
              + h(WP.aden.lat,WP.aden.lon,eastP.lat,eastP.lon);
  } else {
    // SE.Asia / China / Japan / Australia: Aden ‚Üí Malacca ‚Üí destination
    dFromSuez = h(WP.suez.lat,WP.suez.lon,WP.aden.lat,WP.aden.lon)
              + h(WP.aden.lat,WP.aden.lon,WP.malacca.lat,WP.malacca.lon)
              + h(WP.malacca.lat,WP.malacca.lon,eastP.lat,eastP.lon);
  }
  return Math.round((dToSuez+dFromSuez)*1.05);
}

function routedDistance(pA,pB){
  const la1=pA.lat,lo1=pA.lon,la2=pB.lat,lo2=pB.lon;
  const zA=routeZone(pA), zB=routeZone(pB);
  const rA=pA.region||'', rB=pB.region||'';
  const either=set=>set.includes(zA)||set.includes(zB);
  const pair=(a,b)=>(zA===a&&zB===b)||(zA===b&&zB===a);
  let nm, canals=[], warZones=[], routeDesc='Direct';

  const capeNm=()=>Math.round((haversine(la1,lo1,WP.cape.lat,WP.cape.lon)+haversine(WP.cape.lat,WP.cape.lon,la2,lo2))*1.10);
  const panNm =()=>Math.round((haversine(la1,lo1,WP.panama.lat,WP.panama.lon)+haversine(WP.panama.lat,WP.panama.lon,la2,lo2))*1.04);

  // ‚îÄ 1. Atlantic Americas ‚Üî Pacific Americas ‚Üí Panama ‚îÄ
  if(pair('ATL_AMER','PAC_AMER')){
    nm=panNm(); canals=['panama']; routeDesc='via Panama Canal';
  }
  // ‚îÄ 2. European/Med/Black/W.Africa ‚Üî Indian Ocean ‚Üí Suez preferred ‚îÄ
  else if(either(['EUR_MED','BLACK','W_AFRICA']) && either(['INDIAN'])){
    const s=distViaSuez(pA,pB,zA,zB), c=capeNm();
    if(s<c*1.15){ nm=s; canals=['suez']; routeDesc='via Suez Canal'; }
    else { nm=c; routeDesc='via Cape of Good Hope'; }
  }
  // ‚îÄ 3. European/Med/Black/W.Africa ‚Üî Pacific Asia ‚Üí Suez or Cape ‚îÄ
  else if(either(['EUR_MED','BLACK','W_AFRICA']) && either(['ASIA'])){
    const s=distViaSuez(pA,pB,zA,zB), c=capeNm();
    if(s<c*1.15){ nm=s; canals=['suez']; routeDesc='via Suez Canal'; }
    else { nm=c; routeDesc='via Cape of Good Hope'; }
  }
  // ‚îÄ 4. Atlantic Americas ‚Üî Indian Ocean ‚Üí Suez or Cape ‚îÄ
  else if(pair('ATL_AMER','INDIAN')){
    const s=Math.round((haversine(la1,lo1,WP.suez.lat,WP.suez.lon)+haversine(WP.suez.lat,WP.suez.lon,la2,lo2))*1.05);
    const c=capeNm();
    if(s<c*1.12){ nm=s; canals=['suez']; routeDesc='via Suez Canal'; }
    else { nm=c; routeDesc='via Cape of Good Hope'; }
  }
  // ‚îÄ 5. Atlantic Americas ‚Üî Pacific Asia ‚Üí Panama or Cape ‚îÄ
  else if(pair('ATL_AMER','ASIA')){
    const p=panNm(), c=capeNm();
    if(p<=c*1.05){ nm=p; canals=['panama']; routeDesc='via Panama Canal'; }
    else { nm=c; routeDesc='via Cape of Good Hope'; }
  }
  // ‚îÄ 5b. Atlantic Americas ‚Üî Europe/Med ‚îÄ
  // Gulf ports (US GULF, Mexico) must exit via Florida Straits; calibrated √ó1.05.
  // Open-Atlantic ports (US East Coast, South America) use direct haversine √ó1.10.
  else if(pair('ATL_AMER','EUR_MED')){
    const isGulf=r=>['US GULF','MEXICO'].includes(r);
    if(isGulf(rA)||isGulf(rB)){
      const fl=WP.florida;
      nm=Math.round((haversine(la1,lo1,fl.lat,fl.lon)+haversine(fl.lat,fl.lon,la2,lo2))*1.05);
      routeDesc='via Florida Straits';
    } else {
      nm=Math.round(haversine(la1,lo1,la2,lo2)*1.10);
    }
  }
  // ‚îÄ 5c. Atlantic Americas ‚Üî W.Africa ‚îÄ
  // Gulf ports exit Florida Straits; others direct Atlantic.
  else if(pair('ATL_AMER','W_AFRICA')){
    const isGulf=r=>['US GULF','MEXICO'].includes(r);
    if(isGulf(rA)||isGulf(rB)){
      const fl=WP.florida;
      nm=Math.round((haversine(la1,lo1,fl.lat,fl.lon)+haversine(fl.lat,fl.lon,la2,lo2))*1.05);
      routeDesc='via Florida Straits';
    } else {
      nm=Math.round(haversine(la1,lo1,la2,lo2)*1.10);
    }
  }
  // ‚îÄ 5d. Atlantic Americas intra ‚îÄ
  // Gulf ports going to South America must exit via Florida Straits then Caribbean.
  // Calibrated: NO‚ÜíSantos(5421) via Florida(25N,80W)+Caribbean(15N,60W) √ó1.2431.
  // Other intra-Atlantic routes: direct haversine √ó1.10.
  else if(pair('ATL_AMER','ATL_AMER')){
    const isGulf=r=>['US GULF','MEXICO'].includes(r);
    const isSAm =r=>['E.S.AMERICA','N.S.AMERICA'].includes(r);
    if((isGulf(rA)&&isSAm(rB))||(isGulf(rB)&&isSAm(rA))){
      const fl=WP.florida, cb=WP.caribbean;
      nm=Math.round((haversine(la1,lo1,fl.lat,fl.lon)+haversine(fl.lat,fl.lon,cb.lat,cb.lon)+haversine(cb.lat,cb.lon,la2,lo2))*1.2431);
      routeDesc='via Florida Straits';
    } else if(isGulf(rA)||isGulf(rB)){
      const fl=WP.florida;
      nm=Math.round((haversine(la1,lo1,fl.lat,fl.lon)+haversine(fl.lat,fl.lon,la2,lo2))*1.05);
      routeDesc='via Florida Straits';
    } else {
      nm=Math.round(haversine(la1,lo1,la2,lo2)*1.10);
    }
  }
  // ‚îÄ 6. Indian Ocean ‚Üî Pacific Asia ‚Üí via Malacca, waypoints by region ‚îÄ
  // Calibrated factors from 6 real-world distances (see calibration log).
  else if(either(['INDIAN']) && either(['ASIA'])){
    const asiaP = zA==='ASIA' ? pA : pB;
    const indP  = zA==='INDIAN' ? pA : pB;
    const indR  = indP.region||'';
    const m=WP.malacca, sl=WP.srilanka, ad=WP.aden;
    if(['W.INDIA','MIDDLE EAST'].includes(indR)){
      nm=Math.round((haversine(asiaP.lat,asiaP.lon,m.lat,m.lon)
                   + haversine(m.lat,m.lon,sl.lat,sl.lon)
                   + haversine(sl.lat,sl.lon,indP.lat,indP.lon))*1.0548);
    } else if(['E.AFRICA','RED SEA'].includes(indR)){
      nm=Math.round((haversine(asiaP.lat,asiaP.lon,m.lat,m.lon)
                   + haversine(m.lat,m.lon,ad.lat,ad.lon)
                   + haversine(ad.lat,ad.lon,indP.lat,indP.lon))*0.9291);
    } else {
      nm=Math.round((haversine(asiaP.lat,asiaP.lon,m.lat,m.lon)
                   + haversine(m.lat,m.lon,indP.lat,indP.lon))*1.0490);
    }
  }
  // ‚îÄ 7. Pacific Americas ‚Üî Europe/Med/Black ‚Üí Panama then Atlantic ‚îÄ
  // Haversine cuts through South America. Must route via Panama Canal.
  // Factor 1.0244 calibrated on Valparaiso‚ÜíRotterdam(7500).
  else if(either(['PAC_AMER']) && either(['EUR_MED','BLACK'])){
    const p=panNm();
    nm=p; canals=['panama']; routeDesc='via Panama Canal';
  }
  // ‚îÄ 8. Pacific Americas ‚Üî Pacific Asia ‚Üí direct Pacific ‚îÄ
  // Open Pacific crossing, haversine is close to reality.
  // Factor 1.0086 calibrated on Valparaiso‚ÜíShanghai(10221).
  else if(pair('PAC_AMER','ASIA')){
    nm=Math.round(haversine(la1,lo1,la2,lo2)*1.0086);
  }
  // ‚îÄ 9. Pacific Americas ‚Üî Indian Ocean ‚Üí via Cape ‚îÄ
  // Going east (via Panama+Suez) is far longer. Cape is the natural route.
  else if(pair('PAC_AMER','INDIAN')){
    nm=capeNm(); routeDesc='via Cape of Good Hope';
  }
  // ‚îÄ 10. Pacific Americas ‚Üî W.Africa ‚Üí via Panama then direct ‚îÄ
  else if(pair('PAC_AMER','W_AFRICA')){
    nm=panNm(); canals=['panama']; routeDesc='via Panama Canal';
  }
  // ‚îÄ 11. Black Sea ‚Üî Med/Atlantic ‚Üí via Bosphorus ‚îÄ
  else if(either(['BLACK']) && either(['EUR_MED','ATL_AMER','W_AFRICA'])){
    nm=Math.round((haversine(la1,lo1,WP.istanbul.lat,WP.istanbul.lon)+haversine(WP.istanbul.lat,WP.istanbul.lon,la2,lo2))*1.10);
    routeDesc='via Bosphorus';
  }
  // ‚îÄ 12. Same basin / regional ‚îÄ
  // INDIAN intra: √ó1.0085 calibrated on Mumbai‚ÜíMombasa(2418).
  // ASIA intra:   √ó1.0360 calibrated on Tokyo‚ÜíSydney(4362).
  // Others:       √ó1.10 default.
  else {
    const f = (zA==='INDIAN'&&zB==='INDIAN') ? 1.0085
            : (zA==='ASIA'  &&zB==='ASIA'  ) ? 1.0360
            : 1.10;
    nm=Math.round(haversine(la1,lo1,la2,lo2)*f);
  }

  // War zone overlays
  if(rA==='RED SEA'||rB==='RED SEA') warZones.push('redsea');
  if(canals.includes('suez') && either(['INDIAN','ASIA'])){
    if(!warZones.includes('redsea')) warZones.push('redsea');
  }
  if(rA==='BLACK SEA'||rB==='BLACK SEA') warZones.push('blacksea');

  return {nm, canals, warZones, routeDesc};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROUTE OPTIONS
// Returns all realistic routes for a port pair,
// with distances and war zone flags.
// Used to populate the route selector UI.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function routeOptions(pA, pB){
  const zA = routeZone(pA), zB = routeZone(pB);
  const rA = pA.region||'', rB = pB.region||'';
  const either = set => set.includes(zA) || set.includes(zB);
  const pair   = (a,b) => (zA===a&&zB===b)||(zA===b&&zB===a);

  const capeNm = () => Math.round((haversine(pA.lat,pA.lon,WP.cape.lat,WP.cape.lon)+haversine(WP.cape.lat,WP.cape.lon,pB.lat,pB.lon))*1.10);
  const panNm  = () => Math.round((haversine(pA.lat,pA.lon,WP.panama.lat,WP.panama.lon)+haversine(WP.panama.lat,WP.panama.lon,pB.lat,pB.lon))*1.04);
  const suezNm = () => distViaSuez(pA, pB, zA, zB);

  const opts = [];

  // ‚îÄ Atlantic Americas ‚Üî Pacific Americas ‚Üí Panama + Cape ‚îÄ
  if(pair('ATL_AMER','PAC_AMER')){
    opts.push({key:'panama', label:'Via Panama Canal',       nm:panNm(),  canals:['panama'], warZones:[]});
    opts.push({key:'cape',   label:'Via Cape of Good Hope',  nm:capeNm(), canals:[],         warZones:[]});
  }
  // ‚îÄ Europe/Med/Black/W.Africa ‚Üî Indian or Asia ‚Üí Suez + Cape ‚îÄ
  else if(either(['EUR_MED','BLACK','W_AFRICA']) && either(['INDIAN','ASIA'])){
    const s=suezNm(), c=capeNm(), suezWar=[];
    if(!['W.INDIA','E.INDIA','S.INDIA','MIDDLE EAST'].includes(rA)&&
       !['W.INDIA','E.INDIA','S.INDIA','MIDDLE EAST'].includes(rB)) suezWar.push('redsea');
    if(rA==='RED SEA'||rB==='RED SEA') suezWar.push('redsea');
    opts.push({key:'suez', label:'Via Suez Canal',          nm:s, canals:['suez'], warZones:[...new Set(suezWar)]});
    opts.push({key:'cape', label:'Via Cape of Good Hope',   nm:c, canals:[],       warZones:[]});
  }
  // ‚îÄ Atlantic Americas ‚Üî Asia ‚Üí Panama + Cape ‚îÄ
  else if(pair('ATL_AMER','ASIA')){
    opts.push({key:'panama', label:'Via Panama Canal',       nm:panNm(),  canals:['panama'], warZones:[]});
    opts.push({key:'cape',   label:'Via Cape of Good Hope',  nm:capeNm(), canals:[],         warZones:[]});
  }
  // ‚îÄ Atlantic Americas ‚Üî Indian ‚Üí Suez + Cape ‚îÄ
  else if(pair('ATL_AMER','INDIAN')){
    const s=Math.round((haversine(pA.lat,pA.lon,WP.suez.lat,WP.suez.lon)+haversine(WP.suez.lat,WP.suez.lon,pB.lat,pB.lon))*1.05);
    opts.push({key:'suez', label:'Via Suez Canal',          nm:s,        canals:['suez'], warZones:['redsea']});
    opts.push({key:'cape', label:'Via Cape of Good Hope',   nm:capeNm(), canals:[],       warZones:[]});
  }
  // ‚îÄ Atlantic Americas ‚Üî Europe/Med or W.Africa ‚Äî Gulf needs Florida ‚îÄ
  else if(pair('ATL_AMER','EUR_MED')||pair('ATL_AMER','W_AFRICA')){
    const isGulf=r=>['US GULF','MEXICO'].includes(r);
    if(isGulf(rA)||isGulf(rB)){
      const fl=WP.florida;
      const n=Math.round((haversine(pA.lat,pA.lon,fl.lat,fl.lon)+haversine(fl.lat,fl.lon,pB.lat,pB.lon))*1.05);
      opts.push({key:'direct', label:'Via Florida Straits', nm:n, canals:[], warZones:[]});
    } else {
      opts.push({key:'direct', label:'Direct (Atlantic)', nm:Math.round(haversine(pA.lat,pA.lon,pB.lat,pB.lon)*1.10), canals:[], warZones:[]});
    }
  }
  // ‚îÄ Pacific Americas ‚Üî Europe/Med/Black ‚Üí Panama + Cape ‚îÄ
  else if(either(['PAC_AMER'])&&either(['EUR_MED','BLACK'])){
    opts.push({key:'panama', label:'Via Panama Canal',       nm:panNm(),  canals:['panama'], warZones:[]});
    opts.push({key:'cape',   label:'Via Cape of Good Hope',  nm:capeNm(), canals:[],         warZones:[]});
  }
  // ‚îÄ Pacific Americas ‚Üî Asia ‚Üí direct Pacific ‚îÄ
  else if(pair('PAC_AMER','ASIA')){
    opts.push({key:'direct', label:'Direct (Pacific)', nm:Math.round(haversine(pA.lat,pA.lon,pB.lat,pB.lon)*1.0086), canals:[], warZones:[]});
  }
  // ‚îÄ Pacific Americas ‚Üî Indian ‚Üí Cape ‚îÄ
  else if(pair('PAC_AMER','INDIAN')){
    opts.push({key:'cape', label:'Via Cape of Good Hope', nm:capeNm(), canals:[], warZones:[]});
  }
  // ‚îÄ Pacific Americas ‚Üî W.Africa ‚Üí Panama ‚îÄ
  else if(pair('PAC_AMER','W_AFRICA')){
    opts.push({key:'panama', label:'Via Panama Canal', nm:panNm(), canals:['panama'], warZones:[]});
  }
  // ‚îÄ All other routes ‚Üí derive from routedDistance ‚îÄ
  else {
    const {nm, canals, warZones, routeDesc} = routedDistance(pA, pB);
    opts.push({key:'direct', label:routeDesc==='Direct'?'Direct sailing':routeDesc, nm, canals, warZones});
  }

  // Add Black Sea war zone to any route touching Black Sea
  for(const o of opts){
    if(rA==='BLACK SEA'||rB==='BLACK SEA'){
      if(!o.warZones.includes('blacksea')) o.warZones.push('blacksea');
    }
  }

  return opts;
}

// ‚îÄ‚îÄ Build and show the route selector UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateRouteSelector(){
  const lp = portSel.load, dp = portSel.disch;
  const wrap = document.getElementById('routeOptsWrap');
  const list = document.getElementById('routeOptsList');
  const btn  = document.getElementById('calcBtn');
  const btn2 = document.getElementById('calcBtn2');

  if(!lp || !dp){
    wrap.classList.remove('visible');
    btn.style.display = 'block';
    btn2.style.display = 'none';
    return;
  }

  const opts = routeOptions(lp, dp);

  // If only one option, no selector needed ‚Äî just use it directly
  if(opts.length <= 1){
    wrap.classList.remove('visible');
    btn.style.display = 'block';
    btn2.style.display = 'none';
    return;
  }

  // Multiple options ‚Äî show selector, move button below it
  btn.style.display  = 'none';
  btn2.style.display = 'block';
  wrap.classList.add('visible');

  // Find currently selected key (preserve selection on port re-pick)
  const currentKey = document.querySelector('.route-opt.selected')?.dataset?.key || opts[0].key;

  list.innerHTML = opts.map((o, i) => {
    const isSelected = o.key === currentKey || (currentKey === opts[0].key && i === 0 && !document.querySelector('.route-opt.selected'));
    const warnHtml = o.warZones.includes('redsea')
      ? '<span class="route-opt-warn">‚ö† Red Sea war risk</span>' : '';
    return `<label class="route-opt${isSelected?' selected':''}" data-key="${o.key}" onclick="selectRoute(this)">
      <input type="radio" name="routeOpt" value="${o.key}"${isSelected?' checked':''}>
      <span class="route-opt-name">${o.label}</span>
      <span class="route-opt-nm">${o.nm.toLocaleString()} nm</span>
      ${warnHtml}
    </label>`;
  }).join('');
}

function selectRoute(el){
  document.querySelectorAll('.route-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  el.querySelector('input').checked = true;
}

// ‚îÄ‚îÄ Get the currently selected route option ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getSelectedRoute(lp, dp){
  const key = document.querySelector('.route-opt.selected')?.dataset?.key
           || document.querySelector('.route-opt')?.dataset?.key;
  const opts = routeOptions(lp, dp);
  return opts.find(o => o.key === key) || opts[0];
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUNKER HUB ASSIGNMENT
// Returns the most relevant bunkering hub for a
// given route, and the live prices for that hub.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Simple rules (in priority order):
//  1. Via Suez ‚Üí Fujairah (everyone bunkers there)
//  2. Via Panama ‚Üí Houston (Gulf is the natural stop)
//  3. Both zones Asia/Pacific ‚Üí Singapore
//  4. Either zone Asia ‚Üí Singapore
//  5. Either zone Indian Ocean (India/ME) ‚Üí Fujairah
//  6. Either zone Americas ‚Üí Houston
//  7. Default (Europe/Med/Africa) ‚Üí Rotterdam
function getBunkerHub(zA, zB, canals){
  if(canals && canals.includes('suez'))   return 'Fujairah';
  if(canals && canals.includes('panama')) return 'Houston';
  if(zA==='ASIA' && zB==='ASIA')          return 'Singapore';
  if(zA==='ASIA' || zB==='ASIA')          return 'Singapore';
  if(zA==='INDIAN' || zB==='INDIAN')      return 'Fujairah';
  if(['ATL_AMER','PAC_AMER'].includes(zA)||['ATL_AMER','PAC_AMER'].includes(zB)) return 'Houston';
  return 'Rotterdam';
}

// Get live price for a hub, with fallback hardcoded values
// Fallbacks are conservative estimates if scraping fails
const BUNKER_FALLBACKS = {
  Singapore: { vlsfo: 510, mgo: 720 },
  Rotterdam:  { vlsfo: 475, mgo: 715 },
  Houston:    { vlsfo: 490, mgo: 700 },
  Fujairah:   { vlsfo: 510, mgo: 780 },
};

function getBunkerPrices(hub){
  const live = BUNKER_PRICES[hub];
  if(live && live.vlsfo && live.mgo){
    return {
      vlsfo:       live.vlsfo,
      mgo:         live.mgo,
      hub,
      scrapedDate: live.scrapedDate,
      daysOld:     live.daysOld,
      source:      'live',
    };
  }
  // Fallback to hardcoded
  const fb = BUNKER_FALLBACKS[hub] || BUNKER_FALLBACKS['Singapore'];
  return {
    vlsfo:   fb.vlsfo,
    mgo:     fb.mgo,
    hub,
    source:  'fallback',
  };
}


function compute(lp, dp, cargoMt, routeOpt){
  const vr = vesselForCargo(cargoMt);
  const sp = VESSEL_SPECS[vr.v];
  const tcMatch = matchTC(lp.region, dp.region, vr.v);
  const commodity = document.getElementById('commodity')?.value || 'default';

  // Use the user-selected route if provided, otherwise auto-route
  const route = routeOpt || routedDistance(lp, dp);
  const nm        = route.nm;
  const canals    = route.canals;
  const warZones  = route.warZones;
  const routeDesc = route.label || route.routeDesc || 'Direct';

  const canalCosts={};
  for(const c of canals) canalCosts[c]=(TOLLS[c]||{})[vr.v]||0;
  const warCosts={};
  for(const z of warZones) warCosts[z]=Math.round((WAR[z].hull)+(cargoMt*WAR[z].cargoPerMt));

  // Commodity-aware port rates (port-specific ‚Üí regional ‚Üí base)
  const loadRates  = getPortRates(lp, commodity);
  const dischRates = getPortRates(dp, commodity);

  // Ballast factor based on discharge region (where vessel repositions from)
  const ballastFactor = getBallastFactor(dp.region);

  // Bunker hub and live prices for this route
  const zA = routeZone(lp), zB = routeZone(dp);
  const bunkerHub    = getBunkerHub(zA, zB, canals);
  const bunkerPrices = getBunkerPrices(bunkerHub);

  return {vr, sp,
          tcRate: tcMatch.rate, tcMatch,
          nm, canals, warZones, canalCosts, warCosts, routeDesc,
          commodity,
          lRate: loadRates.load,   lRateDisch: loadRates.disch,
          dRate: dischRates.disch, dRateLoad:  dischRates.load,
          ballastFactor,
          bunkerHub, bunkerPrices,
          daLoad: DA[lp.region]||40000, daDisch: DA[dp.region]||40000};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RECOMPUTE FROM EDIT STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function recompute(s){
  // Days
  const ladenDays = s.nm * s.wxFactor / (s.ladenKn * 24);
  const ballDays  = s.nm * s.ballFactor / (s.ballKn * 24);
  const portDays  = (s.cargoMt/s.lRate + 0.75) + (s.cargoMt/s.dRate + 0.75);
  const totalDays = ladenDays + ballDays + portDays;
  // Hire
  const hire = s.tcRate * totalDays;
  // Bunkers
  const ecaLd = ECA.has(s.lp.region)?1.5:0;
  const ecaDd = ECA.has(s.dp.region)?1.5:0;
  const ecaDays = Math.min(ladenDays+ballDays, ecaLd+ecaDd);
  const mainDays = Math.max(0, ladenDays+ballDays-ecaDays);
  const seaDays = ladenDays+ballDays||1;
  const vlsfoQt  = Math.round(mainDays*(s.ladenCons*ladenDays+s.ballCons*ballDays)/seaDays);
  const ecaMgoQt = Math.round(ecaDays*s.ladenCons);
  const portMdoQt= Math.round(portDays*s.portCons);
  const bunkers = Math.round(vlsfoQt*s.vlsfoPrice + ecaMgoQt*s.mgoPrice + portMdoQt*s.mgoPrice);
  // DAs
  const portDAs = s.daLoad + s.daDisch;
  // Canals
  let canalCost=0; for(const k in s.canalCosts) canalCost+=Number(s.canalCosts[k])||0;
  // War
  let warCost=0; for(const k in s.warCosts) warCost+=Number(s.warCosts[k])||0;
  // Commission
  const subtotal = hire+bunkers+portDAs+canalCost+warCost;
  const commission = subtotal * s.commPct/100;
  const total = subtotal + commission;
  const perMt = total / s.cargoMt;
  return {ladenDays,ballDays,portDays,totalDays,hire,vlsfoQt,ecaMgoQt,portMdoQt,bunkers,portDAs,canalCost,warCost,commission,total,perMt,ecaDays};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EDIT STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editState = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PORT SEARCH UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let portSel={load:null,disch:null};
function filterPorts(wh,q){
  const ql=q.toLowerCase().trim();
  const list=ql?PORTS.filter(p=>p.name.toLowerCase().includes(ql)||p.country.toLowerCase().includes(ql)):PORTS;
  renderDD(wh,list.slice(0,80),ql);
  positionDD(wh);
  document.getElementById(wh+'DD').classList.add('open');
}
function openDD(wh){
  if(!document.getElementById(wh+'Search').classList.contains('chosen'))
    renderDD(wh,PORTS.slice(0,80),'');
  positionDD(wh);
  document.getElementById(wh+'DD').classList.add('open');
}
function positionDD(wh){
  // On mobile: anchor dropdown top to just below the input field
  // using fixed positioning so it doesn't shift the page layout
  if(window.innerWidth > 640) return;
  const inp = document.getElementById(wh+'Search');
  const dd  = document.getElementById(wh+'DD');
  const rect = inp.getBoundingClientRect();
  dd.style.top = (rect.bottom + 6) + 'px';
}
function closeDD(wh){setTimeout(()=>document.getElementById(wh+'DD').classList.remove('open'),260);}
function renderDD(wh,list,q){
  const el=document.getElementById(wh+'DD'); el.innerHTML='';
  if(!list.length){el.innerHTML='<div class="ddi"><span class="ddi-meta">No ports found</span></div>';return;}
  list.forEach(p=>{
    const d=document.createElement('div');d.className='ddi';
    const nm=q?p.name.replace(new RegExp('('+q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+')','gi'),'<b style="color:#e8384f">$1</b>'):p.name;
    d.innerHTML=`<span><span class="ddi-name">${nm}</span><span class="ddi-meta">&nbsp;${p.country}</span></span><span class="ddi-tag">${p.region||''}</span>`;
    d.onmousedown=e=>{e.preventDefault();pickPort(wh,p);};
    el.appendChild(d);
  });
}
function pickPort(wh,p){
  portSel[wh]=p;
  const si=document.getElementById(wh+'Search');
  si.value=p.name; si.classList.add('chosen');
  document.getElementById(wh+'Meta').textContent=p.country+' ¬∑ '+p.region;
  document.getElementById(wh+'DD').classList.remove('open');
  checkReady();
}
function checkReady(){
  const ready = !!(portSel.load && portSel.disch);
  document.getElementById('calcBtn').disabled  = !ready;
  document.getElementById('calcBtn2').disabled = !ready;
  updateRouteSelector();
}
function onCargoChange(){
  const mt=parseInt(document.getElementById('cargoMt').value)||50000;
  const vr=vesselForCargo(mt);
  document.getElementById('vaName').textContent=vr.label;
  document.getElementById('vaDetail').textContent=vr.desc;
  // No auto-recalc ‚Äî user must click Calculate
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SECTION TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSec(hdr){
  hdr.classList.toggle('open');
  hdr.nextElementSibling.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORMAT HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const Fm=n=>'$'+Math.round(n).toLocaleString('en-US');
const Fd=n=>n.toFixed(1);
const Fn=n=>n.toLocaleString('en-US');

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MAIN CALCULATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function doCalc(){
  if(!portSel.load||!portSel.disch) return;
  const cargoMt=parseInt(document.getElementById('cargoMt').value)||50000;
  // Get the user-selected route (or first option if selector not shown)
  const routeOpt = getSelectedRoute(portSel.load, portSel.disch);
  const C=compute(portSel.load, portSel.disch, cargoMt, routeOpt);

  // Build edit state with defaults from computed
  editState={
    lp: portSel.load,
    dp: portSel.disch,
    cargoMt,
    vr: C.vr,
    nm: C.nm,
    routeDesc: C.routeDesc,
    canals: C.canals,
    warZones: C.warZones,
    tcMatch: C.tcMatch,
    tcRate: C.tcRate || 0,   // 0 when noData ‚Äî user must fill in
    ladenKn: C.sp.ladenKn,
    ballKn: C.sp.ballKn,
    wxFactor: 1.05,
    ballFactor: C.ballastFactor,
    lRate: C.lRate,
    dRate: C.dRate,
    vlsfoPrice: C.bunkerPrices.vlsfo,
    mgoPrice:   C.bunkerPrices.mgo,
    ladenCons: C.sp.ladenCons,
    ballCons: C.sp.ballCons,
    portCons: C.sp.portCons,
    daLoad: C.daLoad,
    daDisch: C.daDisch,
    canalCosts: {...C.canalCosts},
    warCosts: {...C.warCosts},
    commPct: 3.75,
  };

  // Populate route badges
  const rb=document.getElementById('routeBadges');
  rb.innerHTML=`<span class="rbadge">${portSel.load.name} ‚Üí ${portSel.disch.name}</span>`
    +(C.canals.length?`<span class="rbadge via">${C.routeDesc}</span>`:`<span class="rbadge">${C.routeDesc}</span>`)
    +`<span class="rbadge">${Fn(C.nm)} nm</span>`
    +`<span class="rbadge">${C.vr.label}</span>`;

  // Warnings
  const warns=[];
  if(C.warZones.includes('redsea')) warns.push('‚ö† Red Sea routing ‚Äî Houthi threat area. War risk premium included. Many vessels diverting via Cape (+3,500 nm).');
  if(C.warZones.includes('blacksea')) warns.push('‚ö† Black Sea routing ‚Äî war risk premium included.');
  const wb=document.getElementById('warnBox');
  wb.style.display=warns.length?'block':'none';
  wb.innerHTML=warns.join('<br>');

  // Populate static info spans
  document.getElementById('o-nm').textContent=Fn(C.nm)+' nm';
  document.getElementById('o-routedetail').textContent=C.routeDesc;
  document.getElementById('o-daloadnote').textContent=portSel.load.name+' ('+portSel.load.region+')';
  document.getElementById('o-dadischnote').textContent=portSel.disch.name+' ('+portSel.disch.region+')';

  // TC rate source + confidence note
  (function(){
    const m = C.tcMatch;
    const noteEl = document.getElementById('o-tcnote');
    if(!noteEl) return;

    if(m.noData){
      const hint = m.reverseNote
        ? `<br><span style="color:#bbb;font-size:11px">‚ÑπÔ∏è ${m.reverseNote}</span>`
        : `<br><span style="color:#bbb;font-size:11px">${m.matchNote}</span>`;
      noteEl.innerHTML =
        `<span class="conf-badge none">‚ö† No rate in DB</span>`
        + `&nbsp;<span class="conf-source">Enter TC rate manually</span>`
        + hint;
    } else if(m.source === 'proxy'){
      noteEl.innerHTML =
        `<span class="conf-badge proxy">${m.confidence}/100 Proxy</span>`
        + `<span class="conf-source">Rough signal ‚Äî verify before use</span>`
        + `<br><span style="color:#bbb;font-size:11px">${m.matchNote}</span>`;
    } else {
      const cls = m.confidence >= 80 ? 'high'
                : m.confidence >= 60 ? 'medium'
                : m.confidence >= 40 ? 'low'
                :                      'none';
      const d = m.daysOld === 0 ? 'today'
              : m.daysOld === 1 ? '1d ago'
              : m.daysOld + 'd ago';
      noteEl.innerHTML =
        `<span class="conf-badge ${cls}">${m.confidence}/100</span>`
        + `<span class="conf-source">Scraped ${d} ¬∑ HandyBulk</span>`
        + `<br><span style="color:#bbb;font-size:11px">${m.matchNote}</span>`;
    }
  })();

  // Populate editable inputs
  // If no live TC rate, leave field empty so user must enter manually
  const tcInput = document.getElementById('p-tcrate');
  if(tcInput){
    if(C.tcMatch.noData){
      tcInput.value = '';
      tcInput.placeholder = 'Enter rate‚Ä¶';
      tcInput.style.borderColor = '#e07820';
    } else {
      tcInput.value = C.tcRate;
      tcInput.placeholder = '';
      tcInput.style.borderColor = '';
    }
  }
  setInput('p-ladenspd',  C.sp.ladenKn);
  setInput('p-ballspd',   C.sp.ballKn);
  setInput('p-wx',        1.05);
  setInput('p-ball',      C.ballastFactor);
  setInput('p-lrate',     C.lRate);
  setInput('p-drate',     C.dRate);
  setInput('p-vlsfopx',   C.bunkerPrices.vlsfo);
  setInput('p-mgopx',     C.bunkerPrices.mgo);

  // Show bunker hub and freshness
  const bp = C.bunkerPrices;
  const hubNote = bp.source === 'live'
    ? `${bp.hub} ¬∑ ${bp.daysOld === 0 ? 'today' : bp.daysOld + 'd ago'} ¬∑ Ship & Bunker`
    : `${bp.hub} ¬∑ estimated`;
  const vlsfoNoteEl = document.getElementById('o-vlsfonote');
  const mgoNoteEl   = document.getElementById('o-mgonote');
  if(vlsfoNoteEl) vlsfoNoteEl.textContent = 'VLSFO ¬∑ ' + hubNote;
  if(mgoNoteEl)   mgoNoteEl.textContent   = 'MGO ¬∑ '   + hubNote;
  setInput('p-ladencons', C.sp.ladenCons);
  setInput('p-ballcons',  C.sp.ballCons);
  setInput('p-portcons',  C.sp.portCons);
  setInput('p-daload',    C.daLoad);
  setInput('p-dadisch',   C.daDisch);
  setInput('p-commpct',   3.75);

  // Update ballast factor note to show discharge region
  const ballNote = document.getElementById('o-ballnote');
  if(ballNote) ballNote.textContent = portSel.disch.region + ' discharge region';

  // Update load/discharge rate notes to show commodity + source
  const commLabel = (COMMODITIES[C.commodity]||{}).label || 'Default';
  const lRateNote = document.getElementById('o-lratenote');
  const dRateNote = document.getElementById('o-dratenote');
  const portOverrideL = PORT_RATES_COMM[portSel.load.name];
  const portOverrideD = PORT_RATES_COMM[portSel.disch.name];
  if(lRateNote) lRateNote.textContent = (portOverrideL ? portSel.load.name + ' terminal rate' : portSel.load.region + ' regional rate') + ' ¬∑ ' + commLabel;
  if(dRateNote) dRateNote.textContent = (portOverrideD ? portSel.disch.name + ' terminal rate' : portSel.disch.region + ' regional rate') + ' ¬∑ ' + commLabel;

  // Handle canal section
  const sec4=document.getElementById('sec4');
  if(C.canals.length>0){
    sec4.style.display='block';
    let html='<div class="param-block"><div class="param-block-title">Toll by Vessel Class</div>';
    for(const c of C.canals){
      const cname=c.charAt(0).toUpperCase()+c.slice(1);
      html+=`<div class="param-row">
        <span class="param-lbl">${cname} Canal toll</span>
        <div class="p-inline"><input id="p-canal-${c}" class="p-in" type="number" step="5000" value="${C.canalCosts[c]||0}" oninput="onParamChange()"><span class="p-unit">USD</span></div>
        <span class="param-note">${C.vr.label} class rate</span>
      </div>`;
    }
    html+=`<div class="param-row subtotal-row"><span class="param-lbl">Total canal tolls</span><span class="param-val-display" id="o-canals2">‚Äî</span></div>`;
    html+='</div>';
    document.getElementById('sec4body').innerHTML=html;
  } else {
    sec4.style.display='none';
  }

  // Handle war section
  const sec5=document.getElementById('sec5');
  if(C.warZones.length>0){
    sec5.style.display='block';
    let html='<div class="param-block"><div class="param-block-title">War Risk Premium</div>';
    for(const z of C.warZones){
      const w=WAR[z];
      html+=`<div class="param-row">
        <span class="param-lbl">${w.label}</span>
        <div class="p-inline"><input id="p-war-${z}" class="p-in" type="number" step="5000" value="${C.warCosts[z]||0}" oninput="onParamChange()"><span class="p-unit">USD</span></div>
        <span class="param-note">Hull + cargo (${w.cargoPerMt*100}¬¢/MT)</span>
      </div>`;
    }
    html+=`<div class="param-row subtotal-row"><span class="param-lbl">Total war risk</span><span class="param-val-display" id="o-war2">‚Äî</span></div>`;
    html+='</div>';
    document.getElementById('sec5body').innerHTML=html;
  } else {
    sec5.style.display='none';
  }

  // Update section numbers for commission
  let secIdx=4;
  if(C.canals.length) secIdx++;
  if(C.warZones.length) secIdx++;
  document.getElementById('sec6num').textContent='0'+secIdx;

  // Show results
  document.getElementById('results').style.display='block';

  // Run first calculation pass
  onParamChange();

  document.getElementById('results').scrollIntoView({behavior:'smooth',block:'start'});
}

function setInput(id,val){
  const el=document.getElementById(id);
  if(el) el.value=val;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PARAM CHANGE ‚Äî read inputs, recompute, update spans
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onParamChange(){
  if(!editState) return;
  // Read all inputs into editState
  editState.tcRate    = rv('p-tcrate',    editState.tcRate);
  editState.ladenKn   = rv('p-ladenspd',  editState.ladenKn);
  editState.ballKn    = rv('p-ballspd',   editState.ballKn);
  editState.wxFactor  = rv('p-wx',        editState.wxFactor);
  editState.ballFactor= rv('p-ball',      editState.ballFactor);
  editState.lRate     = rv('p-lrate',     editState.lRate);
  editState.dRate     = rv('p-drate',     editState.dRate);
  editState.vlsfoPrice= rv('p-vlsfopx',   editState.vlsfoPrice);
  editState.mgoPrice  = rv('p-mgopx',     editState.mgoPrice);
  editState.ladenCons = rv('p-ladencons', editState.ladenCons);
  editState.ballCons  = rv('p-ballcons',  editState.ballCons);
  editState.portCons  = rv('p-portcons',  editState.portCons);
  editState.daLoad    = rv('p-daload',    editState.daLoad);
  editState.daDisch   = rv('p-dadisch',   editState.daDisch);
  editState.commPct   = rv('p-commpct',   editState.commPct);
  for(const c of editState.canals)
    editState.canalCosts[c]=rv('p-canal-'+c, editState.canalCosts[c]||0);
  for(const z of editState.warZones)
    editState.warCosts[z]=rv('p-war-'+z, editState.warCosts[z]||0);

  const R=recompute(editState);

  // Hero
  set('o-permt',    R.perMt.toFixed(2));
  set('o-total',    Fm(R.total));
  set('o-days',     Fd(R.totalDays)+'d');
  set('o-dayslbl',  'Total Days ¬∑ '+editState.vr.label);

  // Sec 1: TC Hire
  set('o-hire',      Fm(R.hire));
  set('o-ladendays', Fd(R.ladenDays)+' d');
  set('o-balldays',  Fd(R.ballDays)+' d');
  set('o-portdays',  Fd(R.portDays)+' d');
  set('o-totaldays', Fd(R.totalDays)+' d  ('+Fd(R.ladenDays)+' laden + '+Fd(R.ballDays)+' ballast + '+Fd(R.portDays)+' port)');

  // Sec 2: Bunkers
  set('o-bunk',  Fm(R.bunkers));
  set('o-bunk2', Fm(R.bunkers));
  set('o-vlsfomt',    Fn(R.vlsfoQt)+' MT');
  set('o-vlsfocost',  Fm(R.vlsfoQt*editState.vlsfoPrice));
  set('o-portmdoamt', Fn(R.portMdoQt)+' MT');
  set('o-portmdocost',Fm(R.portMdoQt*editState.mgoPrice));
  const rowMgo=document.getElementById('row-mgo');
  if(rowMgo){
    rowMgo.style.display=R.ecaDays>0?'grid':'none';
    set('o-ecomt',   Fn(R.ecaMgoQt)+' MT');
    set('o-ecocost', Fm(R.ecaMgoQt*editState.mgoPrice));
  }

  // Sec 3: DAs
  set('o-das',  Fm(R.portDAs));
  set('o-das2', Fm(R.portDAs));

  // Sec 4: Canals
  if(editState.canals.length){
    set('o-canals', Fm(R.canalCost));
    if(document.getElementById('o-canals2')) set('o-canals2', Fm(R.canalCost));
  }

  // Sec 5: War
  if(editState.warZones.length){
    set('o-war', Fm(R.warCost));
    if(document.getElementById('o-war2')) set('o-war2', Fm(R.warCost));
  }

  // Sec 6: Commission
  set('o-comm',  Fm(R.commission));
  set('o-comm2', Fm(R.commission));

  // Grand total
  set('o-grandtotal', Fm(R.total));
  set('o-grandpermt', R.perMt.toFixed(2)+' $/MT');
  set('o-gtcargo', Fn(editState.cargoMt)+' MT ¬∑ '+editState.vr.label);
}

function rv(id, fallback){
  const el=document.getElementById(id);
  if(!el) return fallback;
  const v=parseFloat(el.value);
  return isNaN(v)||v<=0 ? fallback : v;
}
function set(id,val){
  const el=document.getElementById(id);
  if(el) el.textContent=val;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAV ‚Äî page switching
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showPage(name){
  document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
  const pg = document.getElementById('page-'+name);
  if(pg) pg.classList.add('active');
  const nl = document.getElementById('nav-'+name);
  if(nl) nl.classList.add('active');
  window.scrollTo({top:0,behavior:'smooth'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STEPPER ‚Äî +/- buttons for number inputs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function stepInput(id, dir){
  const el = document.getElementById(id);
  if(!el) return;
  const step = parseFloat(el.step) || 1;
  const val  = parseFloat(el.value) || 0;
  const min  = el.min !== '' ? parseFloat(el.min) : -Infinity;
  const max  = el.max !== '' ? parseFloat(el.max) :  Infinity;
  const dec  = (step.toString().split('.')[1] || '').length;
  el.value   = Math.min(max, Math.max(min, parseFloat((val + dir*step).toFixed(dec))));
  onParamChange();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FREIGHT TYPE SELECTOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FREIGHT_TYPES = {
  tanker:     { title: 'Tankers ‚Äî Coming Soon', text: 'Crude oil, product tankers, and chemical tankers are next on our roadmap. Live VLCC, Suezmax, and Aframax TC rates are being integrated. Stay tuned.' },
  container:  { title: 'Container Shipping ‚Äî Coming Soon', text: 'Box freight rate calculator covering major liner routes is under development. TEU-based cost breakdowns and spot rate integration are planned.' },
  gas:        { title: 'Gas Carriers ‚Äî Coming Soon', text: 'LNG and LPG carrier voyage estimation is on our roadmap. This is a highly specialised market and we want to get it right before launching.' },
  breakbulk:  { title: 'Break Bulk & Project Cargo ‚Äî Coming Soon', text: 'Ro-Ro, heavy lift, and general cargo voyage costing is planned for a future release.' },
};

function selectFreight(type, evt){
  document.querySelectorAll('.freight-tab').forEach(t=>t.classList.remove('active'));
  if(evt && evt.currentTarget) evt.currentTarget.classList.add('active');

  const devMsg  = document.getElementById('freight-dev-msg');
  const dryBulk = document.getElementById('drybulk-content');

  if(type === 'drybulk'){
    dryBulk.style.display = 'block';
    devMsg.style.display  = 'none';
  } else {
    dryBulk.style.display = 'none';
    const info = FREIGHT_TYPES[type] || { title:'Coming Soon', text:'This segment is under development.' };
    document.getElementById('freight-dev-title').textContent = info.title;
    document.getElementById('freight-dev-text').textContent  = info.text;
    devMsg.style.display = 'block';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
loadData();
</script>
</body>
</html>